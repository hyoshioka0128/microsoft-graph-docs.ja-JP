#  <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a><span data-ttu-id="227aa-101">デルタ クエリを使用して、Microsoft Graph データの変更を追跡する</span><span class="sxs-lookup"><span data-stu-id="227aa-101">Use delta query to track changes in Microsoft Graph data</span></span>

<span data-ttu-id="227aa-p101">デルタ クエリを使用すると、アプリケーションは、要求ごとにターゲット リソースをすべて読み取ることなく、新しく作成、更新、または削除されたエンティティを検出できます。Microsoft Graph アプリケーションはデルタ クエリを使用して、変更をローカル データ ストアと効率的に同期させることができます。</span><span class="sxs-lookup"><span data-stu-id="227aa-p101">Delta query enables applications to discover newly created, updated, or deleted entities without performing a full read of the target resource with every request. Microsoft Graph applications can use delta query to efficiently synchronize changes with a local data store.</span></span>

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a><span data-ttu-id="227aa-104">デルタ クエリを使用して、リソース コレクション内の変更を追跡する</span><span class="sxs-lookup"><span data-stu-id="227aa-104">Use delta query to track changes in a resource collection</span></span>

<span data-ttu-id="227aa-105">標準的な呼び出しパターンは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="227aa-105">The typical call pattern is as follows:</span></span>

1.  <span data-ttu-id="227aa-106">アプリケーションは、まず目的のリソースでデルタ関数を使用して GET 要求を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="227aa-106">The application begins by calling a GET request with the delta function on the desired resource.</span></span>
2.  <span data-ttu-id="227aa-107">Microsoft Graph は、要求されたリソースと[状態トークン](#state-tokens)を含む応答を送信します。</span><span class="sxs-lookup"><span data-stu-id="227aa-107">Microsoft Graph sends a response containing the requested resource and a [state token](#state-tokens).</span></span>

     <span data-ttu-id="227aa-p102">a. `nextLink` URL が返される場合は、セッションに取得するデータの追加ページがあります。`deltaLink` URL が応答で返されるまで、アプリケーションは `nextLink` URL を使用してデータのすべてのページを取得する要求を実行し続けます。</span><span class="sxs-lookup"><span data-stu-id="227aa-p102">a.  If a `nextLink` URL is returned, there may be additional pages of data to be retrieved in the session. The application continues making requests using the `nextLink` URL to retrieve all pages of data until a `deltaLink` URL is returned in the response.</span></span>

     <span data-ttu-id="227aa-p103">b.`deltaLink` URL が返される場合、返されるリソースの既存の状態に関するデータはありません。以降の要求では、アプリケーションは `deltaLink` URL を使用して、リソースへの変更点を確認します。</span><span class="sxs-lookup"><span data-stu-id="227aa-p103">b.  If a `deltaLink` URL is returned, there is no more data about the existing state of the resource to be returned. For future requests, the application uses the `deltaLink` URL to learn about changes to the resource.</span></span>
     
3.  <span data-ttu-id="227aa-p104">アプリケーションがリソースの変更を把握する必要がある場合、アプリケーションは手順 2 で受け取った `deltaLink` URL を使用して、新しい要求を実行します。この要求は、手順 2 が完了した直後、またはアプリケーションが変更を確認する際に実行できる*場合があります*。</span><span class="sxs-lookup"><span data-stu-id="227aa-p104">When the application needs to learn about changes to the resource, it makes a new request using the `deltaLink` URL received in step 2. This request *may* be made immediately after completing step 2 or when the application checks for changes.</span></span>
4.  <span data-ttu-id="227aa-116">Microsoft Graph は、前の要求以降のリソースへの変更を説明する応答と、`nextLink` URL または `deltaLink` URL のいずれかを返します。</span><span class="sxs-lookup"><span data-stu-id="227aa-116">Microsoft Graph returns a response describing changes to the resource since the previous request, and either a `nextLink` URL or a `deltaLink` URL.</span></span>

### <a name="state-tokens"></a><span data-ttu-id="227aa-117">状態トークン</span><span class="sxs-lookup"><span data-stu-id="227aa-117">State tokens</span></span>

<span data-ttu-id="227aa-p105">デルタ クエリの GET 応答には、`nextLink` または `deltaLink` の応答ヘッダーに指定された URL が常に含まれています。`nextLink` URL には _skipToken_、`deltaLink` URL には _deltaToken_ が含まれています。</span><span class="sxs-lookup"><span data-stu-id="227aa-p105">A delta query GET response always includes a URL specified in a `nextLink` or `deltaLink` response header. The `nextLink` URL includes a _skipToken_, and a `deltaLink` URL includes a _deltaToken_.</span></span> 

<span data-ttu-id="227aa-p106">これらのトークンは、クライアントに対して不透明です。理解しておく必要のある事項の詳細を、以下に示します。</span><span class="sxs-lookup"><span data-stu-id="227aa-p106">These tokens are opaque to the client. The following details are what you need to know about them:</span></span>

- <span data-ttu-id="227aa-122">各トークンは状態を反映し、そのラウンドの変更追跡におけるリソースのスナップショットを表します。</span><span class="sxs-lookup"><span data-stu-id="227aa-122">Each token reflects the state and represents a snapshot of the resource in that round of change tracking.</span></span> 
- <span data-ttu-id="227aa-p107">状態トークンは、初期デルタ クエリ要求で指定された他のクエリ パラメーター (`$select` など) もエンコードして含めます。したがって、後続のデルタ クエリ要求でそれらを繰り返す必要はありません。</span><span class="sxs-lookup"><span data-stu-id="227aa-p107">The state tokens also encode and include other query parameters (such as `$select`) specified in the initial delta query request. Therefore, it's not required to repeat them in subsequent delta query requests.</span></span>
- <span data-ttu-id="227aa-125">デルタ クエリを実行するときは、状態トークンなど、URL の内容を調べることなく、`nextLink` または `deltaLink` の URL を次の**デルタ**関数呼び出しにコピーして適用できます。</span><span class="sxs-lookup"><span data-stu-id="227aa-125">When carrying out delta query, you can copy and apply the `nextLink` or `deltaLink` URL to the next **delta** function call without having to inspect the contents of the URL, including its state token.</span></span>


### <a name="optional-query-parameters"></a><span data-ttu-id="227aa-126">オプションのクエリ パラメーター</span><span class="sxs-lookup"><span data-stu-id="227aa-126">Optional query parameters</span></span>

<span data-ttu-id="227aa-p108">クライアントがクエリ パラメーターを使用する場合は、最初の要求で指定する必要があります。Microsoft Graph は、応答で提供される `nextLink` または `deltaLink` に指定したパラメーターを自動的にエンコードします。呼び出し元のアプリケーションで必要な操作は、必要なクエリ パラメーターを最初に一度指定することだけです。Microsoft Graph は、すべての後続の要求に対して自動的に指定されたパラメーターを追加します。</span><span class="sxs-lookup"><span data-stu-id="227aa-p108">If a client uses a query parameter, it must be specified in the initial request. Microsoft Graph automatically encodes the specified parameter into the `nextLink` or `deltaLink` provided in the response. The calling application only needs to specify their desired query parameters once upfront. Microsoft Graph adds the specified parameters automatically for all subsequent requests.</span></span>

<span data-ttu-id="227aa-131">ユーザーとグループには、いくつかのクエリ パラメーターの使用に関する制限があります。</span><span class="sxs-lookup"><span data-stu-id="227aa-131">For users and groups, there are restrictions on using some query parameters:</span></span>

-   <span data-ttu-id="227aa-p109">`$select` クエリ パラメーターが使用されている場合、パラメーターは、`$select` ステートメントで指定したプロパティまたはリレーションシップに関する変更のみを追跡することを、クライアントが優先していることを示します。選択されていないプロパティに変更が加えられた場合、そのプロパティが変更されたリソースは、後続の要求後のデルタ応答には表示されなくなります。</span><span class="sxs-lookup"><span data-stu-id="227aa-p109">If a `$select` query parameter is used, the parameter indicates that the client prefers to only track changes on the properties or relationships specified in the `$select` statement. If a change occurs to a property that is not selected, the resource for which that property changed does not appear in the delta response after a subsequent request.</span></span>
-   <span data-ttu-id="227aa-134">`$expand` はサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="227aa-134">`$expand` is not supported.</span></span>

<span data-ttu-id="227aa-p110">ユーザーとグループの API については、スコープフィルターで、objectID を使って 1 つまたは複数の特定のユーザーまたはグループに加えられた変更を追跡できます。たとえば、https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' の要求では、クエリ フィルターで指定された ID に一致するグループに加えられた変更が返されます。</span><span class="sxs-lookup"><span data-stu-id="227aa-p110">For users and groups beta (preview) APIs, scoping filters allow you to track changes to one or more specific users or groups by objectId. For example, the following request: https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' returns changes for the groups matching the ids specified in the query filter.</span></span> 

## <a name="resource-representation-in-the-delta-query-response"></a><span data-ttu-id="227aa-137">デルタ クエリ応答でのリソース表記</span><span class="sxs-lookup"><span data-stu-id="227aa-137">Resource representation in the delta query response</span></span>

-   <span data-ttu-id="227aa-138">サポートされているリソースの新しく作成されたインスタンスは、標準的な表現を使用してデルタ クエリ応答で表されます。</span><span class="sxs-lookup"><span data-stu-id="227aa-138">Newly created instances of a supported resource are represented in the delta query response using their standard representation.</span></span>

-   <span data-ttu-id="227aa-139">更新されたインスタンスは、*少なくとも*更新されたプロパティを持つ **ID** で表されますが、追加のプロパティが含まれる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="227aa-139">Updated instances are represented by their **id** with *at least* the properties that have been updated, but additional properties may be included.</span></span>

-   <span data-ttu-id="227aa-p111">ユーザーとグループのリレーションシップは、標準的なリソース表記で注釈として表されます。これらの注釈は `propertyName@delta` の形式で表示されます。注釈は最初のデルタ クエリ要求の応答に含まれます。</span><span class="sxs-lookup"><span data-stu-id="227aa-p111">Relationships on users and groups are represented as annotations on the standard resource representation. These annotations use the format `propertyName@delta`. The annotations are included in the response of the initial delta query request.</span></span>

<span data-ttu-id="227aa-p112">削除されたインスタンスは、**ID** と `@removed` オブジェクトを使用して表されます。`@removed` オブジェクトには、インスタンスが削除された理由に関する追加情報が含まれる場合があります。たとえば、"@removed": {"reason": “changed”} です。</span><span class="sxs-lookup"><span data-stu-id="227aa-p112">Removed instances are represented by their **id** and an `@removed` object. The `@removed` object may include additional information about why the instance was removed. For example,  "@removed": {"reason": “changed”}.</span></span>

<span data-ttu-id="227aa-146">"@removed" で考えられる理由は、*changed* または *deleted* です。</span><span class="sxs-lookup"><span data-stu-id="227aa-146">Possible @removed reasons can be *changed* or *deleted*.</span></span>
- <span data-ttu-id="227aa-147">*Changed* は、項目は削除されたものの、[deletedItems](../api-reference/beta/resources/directory.md) から復元できることを表します。</span><span class="sxs-lookup"><span data-stu-id="227aa-147">*Changed* indicates the item was deleted and can be restored from [deletedItems](../api-reference/beta/resources/directory.md).</span></span>
- <span data-ttu-id="227aa-148">*Deleted* は、項目は削除され、復元できないことを表します。</span><span class="sxs-lookup"><span data-stu-id="227aa-148">*Deleted* indicates the item is deleted and cannot be restored.</span></span>

<span data-ttu-id="227aa-p113">`@removed` オブジェクトは最初のデルタ クエリ応答と追跡された (deltaLink) 応答で返されます。デルタ クエリ要求を使用するクライアントは、応答に含まれるこれらのオブジェクトを処理できるよう設計する必要があります。</span><span class="sxs-lookup"><span data-stu-id="227aa-p113">The `@removed` object can be returned in the initial delta query response and in tracked (deltaLink) responses. Clients using delta query requests should be designed to handle these objects in the responses.</span></span>

## <a name="supported-resources"></a><span data-ttu-id="227aa-151">サポートされているリソース</span><span class="sxs-lookup"><span data-stu-id="227aa-151">Supported resources</span></span>

<span data-ttu-id="227aa-152">デルタ クエリは現在、次のリソースでサポートされています。</span><span class="sxs-lookup"><span data-stu-id="227aa-152">Delta query is currently supported for the following resources.</span></span>

| <span data-ttu-id="227aa-153">**リソース コレクション**</span><span class="sxs-lookup"><span data-stu-id="227aa-153">**Resource collection**</span></span> | <span data-ttu-id="227aa-154">**API**</span><span class="sxs-lookup"><span data-stu-id="227aa-154">**API**</span></span> |
|:------ | :------ |
| <span data-ttu-id="227aa-155">標準として設定されている予定表の予定表ビュー (期間) 内のイベント</span><span class="sxs-lookup"><span data-stu-id="227aa-155">Events in a calendar view (date range) of the primary calendar</span></span> | <span data-ttu-id="227aa-156">[イベント](../api-reference/v1.0/resources/event.md)リソースの[デルタ](../api-reference/v1.0/api/event_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-156">[delta](../api-reference/v1.0/api/event_delta.md) function of the [event](../api-reference/v1.0/resources/event.md) resource</span></span> |
| <span data-ttu-id="227aa-157">グループ</span><span class="sxs-lookup"><span data-stu-id="227aa-157">Groups</span></span> | <span data-ttu-id="227aa-158">[グループ](../api-reference/v1.0/resources/group.md)リソースの[デルタ](../api-reference/v1.0/api/group_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-158">[delta](../api-reference/v1.0/api/group_delta.md) function of the [group](../api-reference/v1.0/resources/group.md) resource</span></span> |
| <span data-ttu-id="227aa-159">メール フォルダー</span><span class="sxs-lookup"><span data-stu-id="227aa-159">Mail folders</span></span> | <span data-ttu-id="227aa-160">[mailFolder](../api-reference/v1.0/resources/mailFolder.md) リソースの[デルタ](../api-reference/v1.0/api/mailfolder_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-160">[delta](../api-reference/v1.0/api/mailfolder_delta.md) function of the [mailFolder](../api-reference/v1.0/resources/mailFolder.md) resource</span></span> |
| <span data-ttu-id="227aa-161">フォルダー内のメッセージ</span><span class="sxs-lookup"><span data-stu-id="227aa-161">Messages in a folder</span></span> | <span data-ttu-id="227aa-162">[メッセージ](../api-reference/v1.0/resources/message.md)リソースの[デルタ](../api-reference/v1.0/api/message_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-162">[delta](../api-reference/v1.0/api/message_delta.md) function of the [message](../api-reference/v1.0/resources/message.md) resource</span></span> | 
| <span data-ttu-id="227aa-163">個人用連絡先フォルダー</span><span class="sxs-lookup"><span data-stu-id="227aa-163">Personal contact folders</span></span> | <span data-ttu-id="227aa-164">[contactFolder](../api-reference/v1.0/resources/contactfolder.md) リソースの[デルタ](../api-reference/v1.0/api/contactfolder_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-164">[delta](../api-reference/v1.0/api/contactfolder_delta.md) function of the [contactFolder](../api-reference/v1.0/resources/contactfolder.md) resource</span></span> |
| <span data-ttu-id="227aa-165">フォルダー内の個人用連絡先</span><span class="sxs-lookup"><span data-stu-id="227aa-165">Personal contacts in a folder</span></span> | <span data-ttu-id="227aa-166">[連絡先](../api-reference/v1.0/resources/contact.md)リソースの[デルタ](../api-reference/v1.0/api/contact_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-166">[delta](../api-reference/v1.0/api/contact_delta.md) function of the [contact](../api-reference/v1.0/resources/contact.md) resource</span></span> |
| <span data-ttu-id="227aa-167">ユーザー</span><span class="sxs-lookup"><span data-stu-id="227aa-167">Users</span></span> | <span data-ttu-id="227aa-168">[ユーザー](../api-reference/v1.0/resources/user.md)リソースの[デルタ](../api-reference/v1.0/api/user_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-168">[delta](../api-reference/v1.0/api/user_delta.md) function of the [user](../api-reference/v1.0/resources/user.md) resource</span></span> | 
| <span data-ttu-id="227aa-169">ドライブの項目\*</span><span class="sxs-lookup"><span data-stu-id="227aa-169">Drive items\*</span></span> | <span data-ttu-id="227aa-170">[driveItem](../api-reference/v1.0/resources/driveitem.md) リソースの[デルタ](../api-reference/v1.0/api/driveitem_delta.md)関数</span><span class="sxs-lookup"><span data-stu-id="227aa-170">[delta](../api-reference/v1.0/api/driveitem_delta.md) function of the [driveItem](../api-reference/v1.0/resources/driveitem.md) resource</span></span> |


> <span data-ttu-id="227aa-p114">\* OneDrive リソースの使用パターンは、他のサポートされているリソースと似ていますが、構文には若干の違いがあります。ドライブのデルタ クエリは、他のリソースの種類との一貫性を保つために将来更新されます。現在の構文の詳細については、「[ドライブの変更履歴を記録する](https://developer.microsoft.com/ja-JP/graph/docs/api-reference/v1.0/api/item_delta)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="227aa-p114">\* The usage pattern for OneDrive resources is similar to the other supported resources with some minor syntax differences. Delta query for drives will be updated in the future to be consistent with other resource types. For more detail about the current syntax, see [Track changes for a Drive](https://developer.microsoft.com/ja-JP/graph/docs/api-reference/v1.0/api/item_delta).</span></span>

## <a name="prerequisites"></a><span data-ttu-id="227aa-174">前提条件</span><span class="sxs-lookup"><span data-stu-id="227aa-174">Prerequisites</span></span>

<span data-ttu-id="227aa-175">特定のリソースを読み取るために必要な[アクセス許可](./permissions_reference.md)と同じアクセス許可も、そのリソースでデルタ クエリを実行するために必要です。</span><span class="sxs-lookup"><span data-stu-id="227aa-175">The same [permissions](./permissions_reference.md) that are required to read a specific resource are also required to perform delta query on that resource.</span></span>

## <a name="delta-query-request-examples"></a><span data-ttu-id="227aa-176">デルタ クエリ要求の例</span><span class="sxs-lookup"><span data-stu-id="227aa-176">Delta query request examples</span></span> 

- [<span data-ttu-id="227aa-177">カレンダー ビューのイベントへの増分の変更を取得する</span><span class="sxs-lookup"><span data-stu-id="227aa-177">Get incremental changes to events in a calendar view</span></span>](../concepts/delta_query_events.md)
- [<span data-ttu-id="227aa-178">フォルダー内のメッセージへの増分の変更を取得する</span><span class="sxs-lookup"><span data-stu-id="227aa-178">Get incremental changes to messages in a folder</span></span>](./delta_query_messages.md)
- [<span data-ttu-id="227aa-179">グループへの増分の変更を取得する</span><span class="sxs-lookup"><span data-stu-id="227aa-179">Get incremental changes to groups</span></span>](./delta_query_groups.md)
- [<span data-ttu-id="227aa-180">ユーザーへの増分の変更を取得する</span><span class="sxs-lookup"><span data-stu-id="227aa-180">Get incremental changes to users</span></span>](./delta_query_users.md)
