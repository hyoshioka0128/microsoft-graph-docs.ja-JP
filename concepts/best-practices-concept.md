# <a name="best-practices-for-working-with-microsoft-graph"></a><span data-ttu-id="602d7-101">Microsoft Graph の操作に関するベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="602d7-101">Best practices for working with the OneNote API in Microsoft Graph</span></span>

<span data-ttu-id="602d7-102">この記事では、アプリケーションで Microsoft Graph を最大限に活用するのに役立つベスト プラクティスについて説明します。これには、Microsoft Graph の概要、アプリのパフォーマンス向上、エンドユーザーに対してアプリケーションの信頼性を高める方法が含まれます。</span><span class="sxs-lookup"><span data-stu-id="602d7-102">This article describes best practices that you can apply to help your applications get the most out of Microsoft Graph - whether that involves learning about Microsoft Graph, improving app performance, or making your application more reliable for end users.</span></span>

## <a name="use-graph-explorer-to-get-to-know-the-api"></a><span data-ttu-id="602d7-103">Graph エクスプローラーを使用して API を理解する</span><span class="sxs-lookup"><span data-stu-id="602d7-103">Use Graph Explorer to get to know the API</span></span>

<span data-ttu-id="602d7-104">Microsoft Graph で利用できるデータについての理解を深める最も良い方法は、[Graph エクスプローラー](https://aka.ms/ge)を使用してみることです。</span><span class="sxs-lookup"><span data-stu-id="602d7-104">The easiest way to start exploring the data available through Microsoft Graph is to use [Graph Explorer](https://aka.ms/ge).</span></span> <span data-ttu-id="602d7-105">Graph エクスプローラーを使用すると、CRUD をすべてサポートした REST 要求を作成し、HTTP 要求ヘッダーを適合させて、データ応答を確認できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-105">Graph Explorer lets you craft REST requests (with full CRUD support), adapt the HTTP request headers, and see the data responses.</span></span> <span data-ttu-id="602d7-106">Graph エクスプローラーには、作業の開始に役立つ一連のサンプル クエリが用意されています。</span><span class="sxs-lookup"><span data-stu-id="602d7-106">To help you get started, Graph Explorer also provides a set of sample queries.</span></span>

<span data-ttu-id="602d7-107">新しい API をアプリケーションに統合する前に、それらを試してみてください。</span><span class="sxs-lookup"><span data-stu-id="602d7-107">Experiment with new APIs before you integrate them into your application.</span></span>

## <a name="authentication"></a><span data-ttu-id="602d7-108">認証</span><span class="sxs-lookup"><span data-stu-id="602d7-108">Authentication</span></span>

<span data-ttu-id="602d7-109">Microsoft Graph のデータにアクセスするには、アプリケーションが OAuth 2.0 アクセス トークンを取得し、次のいずれかの方法でそれを Microsoft Graph に提示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-109">To access the data in Microsoft Graph, your application will need to acquire an OAuth 2.0 access token, and present it to Microsoft Graph in either of the following:</span></span>

- <span data-ttu-id="602d7-110">HTTP *Authorization* 要求ヘッダー (*Bearer* トークンとして)</span><span class="sxs-lookup"><span data-stu-id="602d7-110">The HTTP *Authorization* request header, as a *Bearer* token</span></span>
- <span data-ttu-id="602d7-111">グラフ クライアント コンストラクター (Microsoft Graph クライアント ライブラリを使用する場合)</span><span class="sxs-lookup"><span data-stu-id="602d7-111">The graph client constructor, when using a Microsoft Graph client library</span></span>

<span data-ttu-id="602d7-112">Microsoft Authentication Library API ([MSAL](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries)) を使用して、Microsoft Graph へのアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="602d7-112">Use the Microsoft Authentication Library API, [MSAL](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries) to acquire the access token to Microsoft Graph.</span></span>

## <a name="consent-and-authorization"></a><span data-ttu-id="602d7-113">同意と承認</span><span class="sxs-lookup"><span data-stu-id="602d7-113">Consent and authorization</span></span>

<span data-ttu-id="602d7-114">アプリで同意と承認を行うには、次のベスト プラクティスを適用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-114">Apply the following best practices for consent and authorization in your app:</span></span>

- <span data-ttu-id="602d7-115">**最小限の権限を使用する**。</span><span class="sxs-lookup"><span data-stu-id="602d7-115">**Use least privilege**.</span></span> <span data-ttu-id="602d7-116">絶対に必要なアクセス許可のみを、本当に必要な場合に限って要求します。</span><span class="sxs-lookup"><span data-stu-id="602d7-116">Only request permissions that are absolutely necessary, and only when you need them.</span></span> <span data-ttu-id="602d7-117">アプリケーションが呼び出す API の場合、メソッドに関するトピックの「アクセス許可」セクションを確認し (例として「[ユーザーを作成する](../api-reference/v1.0/api/user_post_users.md)」をご覧ください)、必要最小限の権限が付与されたアクセス許可を選択します。</span><span class="sxs-lookup"><span data-stu-id="602d7-117">For the APIs your application calls, check the permissions section in the method topics (for example, see [creating a user](../api-reference/v1.0/api/user_post_users.md), and choose the least privileged permissions.</span></span> <span data-ttu-id="602d7-118">アクセス許可の完全な一覧については、「[アクセス許可のリファレンス](permissions_reference.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="602d7-118">For a full list of permissions, see [permissions reference](permissions_reference.md).</span></span>

- <span data-ttu-id="602d7-119">**シナリオに応じて適切なアクセス許可の種類を使用する**。</span><span class="sxs-lookup"><span data-stu-id="602d7-119">**Use the correct permission type based on scenarios**.</span></span> <span data-ttu-id="602d7-120">サインインしているユーザーが存在している対話型のアプリケーションを作成する場合、そのアプリケーションは*委任された*アクセス許可を使用する必要があります。これにより、アプリケーションはアクセス許可を委任され、Microsoft Graph に呼び出しを行う際にサインインしているユーザーとして動作します。</span><span class="sxs-lookup"><span data-stu-id="602d7-120">If you're building an interactive application where a signed in user is present, your application should use *delegated* permissions, where the application is delegated permission to act as the signed-in user when making calls to Microsoft Graph.</span></span> <span data-ttu-id="602d7-121">ただし、バックグラウンド サービスまたはデーモンなど、サインインしているユーザーなしで動作するアプリケーションの場合は、アプリケーションのアクセス許可を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-121">If, however, your application runs without a signed-in user, such as a background service or daemon, your application should use application permissions.</span></span>

    ><span data-ttu-id="602d7-122">**注:** アプリケーションのアクセス許可を対話型のシナリオで使用すると、アプリケーションがコンプライアンスやセキュリティ上のリスクにさらされる恐れがあります。</span><span class="sxs-lookup"><span data-stu-id="602d7-122">**Note:** Using application permissions for interactive scenarios can put your application at compliance and security risk.</span></span> <span data-ttu-id="602d7-123">これにより、ユーザーの権限を誤って昇格させ、管理者によって設定されたポリシーを回避してデータにアクセスできるようにしてしまう可能性があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-123">It can inadvertantly elevate a user's privileges to access data, circumnavigating policies configured by an administrator.</span></span>
<!-- LG: Use a more clear lead-in here, like "Consider the end user and admin experience"? -->
- <span data-ttu-id="602d7-124">**慎重にアプリを構成する**。</span><span class="sxs-lookup"><span data-stu-id="602d7-124">**Be thoughtful when configuring your app**.</span></span> <span data-ttu-id="602d7-125">これは、エンドユーザーや管理者のエクスペリエンス、およびアプリケーションの導入とセキュリティに直接影響します。</span><span class="sxs-lookup"><span data-stu-id="602d7-125">This will directly affect end user and admin experiences, along with application adoption and security.</span></span> <span data-ttu-id="602d7-126">例:</span><span class="sxs-lookup"><span data-stu-id="602d7-126">For example:</span></span>

    - <span data-ttu-id="602d7-127">アプリケーションのプライバシーに関する声明、使用条件、名前、ロゴ、ドメインは、同意その他の操作で表示されるので、エンドユーザーが理解できるように慎重に構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-127">Your application's privacy statement, terms of use, name, logo and domain will show up in consent and other experiences - so make sure to configure these carefully so they are understood by your end-users.</span></span>
    - <span data-ttu-id="602d7-128">アプリケーションに同意するのがどのようなユーザーなのか (エンドユーザーか管理者か) を考慮した上で、アプリケーションが[適切なアクセス許可を要求する](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-scopes)ように構成します。</span><span class="sxs-lookup"><span data-stu-id="602d7-128">Consider who will be consenting to your application - either end users or administrators - and configure your application to [request permissions appropriately](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-scopes).</span></span>
    - <span data-ttu-id="602d7-129">[静的、動的、増分同意](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-compare#incremental-and-dynamic-consent)の違いを確実に理解している必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-129">Ensure that you understand the difference between [static, dynamic and incremental consent](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-compare#incremental-and-dynamic-consent).</span></span>

- <span data-ttu-id="602d7-130">**マルチテナント アプリケーションを考慮する**。</span><span class="sxs-lookup"><span data-stu-id="602d7-130">**Consider multi-tenant applications**.</span></span> <span data-ttu-id="602d7-131">ユーザーによって、アプリケーションや同意のコントロールはまちまちで、その状態もさまざまであることを想定します。</span><span class="sxs-lookup"><span data-stu-id="602d7-131">Expect customers to have various application and consent controls in different states.</span></span> <span data-ttu-id="602d7-132">例:</span><span class="sxs-lookup"><span data-stu-id="602d7-132">For example:</span></span>

    - <span data-ttu-id="602d7-133">テナント管理者は、エンドユーザーがアプリケーションに同意する機能を無効にできます。</span><span class="sxs-lookup"><span data-stu-id="602d7-133">Tenant administrators can disable the ability for end users to consent to applications.</span></span> <span data-ttu-id="602d7-134">この例では、管理者がユーザーに代わって同意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-134">In this case, an administrator would need to consent on behalf of their users.</span></span>
    - <span data-ttu-id="602d7-135">テナント管理者は、ユーザーが他のユーザーのプロファイルを読み取れないようにする場合や、セルフ サービスのグループ作成を限られたユーザーのみに限定する場合のように、カスタム承認ポリシーを設定できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-135">Tenant administrators can set custom authorization policies such as blocking users from reading other user's profiles, or limiting self-service group creation to a limited set of users.</span></span> <span data-ttu-id="602d7-136">この例では、アプリケーションがあるユーザーの代理として動作している場合、そのアプリケーションが 403 エラー応答を処理することを想定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-136">In this case, your application should expect to handle 403 error response when acting on behalf of a user.</span></span>

## <a name="handle-responses-effectively"></a><span data-ttu-id="602d7-137">応答を効果的に処理する</span><span class="sxs-lookup"><span data-stu-id="602d7-137">Handle responses effectively</span></span>

<span data-ttu-id="602d7-138">Microsoft Graph に対して行う要求に応じて、アプリケーションがさまざまな種類の応答を処理できるようにしておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-138">Depending on the requests you make to Microsoft Graph, your applications should be prepared to handle different types of responses.</span></span> <span data-ttu-id="602d7-139">エンドユーザーがアプリケーションの動作を信頼し予測できるようにするために従う必要のある、最も重要なプラクティスの一部を次に示します。</span><span class="sxs-lookup"><span data-stu-id="602d7-139">The following are some of the most important practices to follow to ensure that your application behaves reliably and predictably for your end users.</span></span>

### <a name="pagination"></a><span data-ttu-id="602d7-140">改ページ</span><span class="sxs-lookup"><span data-stu-id="602d7-140">Pagination</span></span>

<span data-ttu-id="602d7-141">リソース コレクションのクエリを実行する場合、Microsoft Graph が返す結果セットは、サーバー側のページ サイズ制限が原因で複数ページになることを想定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-141">When querying a resource collection, you should expect that Microsoft Graph will the return result set in multiple pages, due to server-side page size limits.</span></span> <span data-ttu-id="602d7-142">要求セットが複数ページにまたがる場合、Microsoft Graph は、結果の次ページへの URL を格納する `@odata.nextLink` プロパティを応答で返します。</span><span class="sxs-lookup"><span data-stu-id="602d7-142">Some queries against Microsoft Graph return multiple pages of data either due to server-side paging or due to the use of the  query parameter to specifically limit the page size in a request. When a result set spans multiple pages, Microsoft Graph returns an `@odata.nextLink` property in the response that contains a URL to the next page of results.</span></span>

<span data-ttu-id="602d7-143">たとえば、サインインしているユーザーを一覧表示する次のようなメッセージの場合、</span><span class="sxs-lookup"><span data-stu-id="602d7-143">For example, listing the signed-in users messages:</span></span>

```http
GET https://graph.microsoft.com/v1.0/me/messages
```

<span data-ttu-id="602d7-144">結果セットがサーバー側のページ サイズ制限を超えると、`@odata.nextLink` プロパティを格納した応答が返されます。</span><span class="sxs-lookup"><span data-stu-id="602d7-144">Would return a response containing an `@odata.nextLink` property, if the result set exceeds the server-side page size limit.</span></span>

```json
"@odata.nextLink": "https://graph.microsoft.com/v1.0/me/messages?$skip=23"
```

><span data-ttu-id="602d7-145">**注:** 作成するアプリケーションは、応答が実際にページングされている可能性を**常に**考慮し、結果の次ページのセットを取得する `@odata.nextLink` プロパティを使用して、結果セットのページを最後まですべて読み取るようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-145">**Note:** Your application should **always** handle the possibility that the responses are paged in nature, and use the `@odata.nextLink` property to obtain the next paged set of results, until all pages of the result set have been read.</span></span> <span data-ttu-id="602d7-146">最後のページには、`@odata.nextLink` プロパティが含まれません。</span><span class="sxs-lookup"><span data-stu-id="602d7-146">The final page will not contain an `@odata.nextLink` property.</span></span> <span data-ttu-id="602d7-147">結果の次ページを要求する際は、その URL 全体を符号化文字列として処理して `@odata:nextLink` プロパティに格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-147">Important: You should include the entire URL in the `@odata:nextLink` property in your request for the next page of results.</span></span>

<span data-ttu-id="602d7-148">詳しくは、「[ページング](paging.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="602d7-148">For more details, see [](paging.md).</span></span>

### <a name="handling-expected-errors"></a><span data-ttu-id="602d7-149">予想されるエラーの処理</span><span class="sxs-lookup"><span data-stu-id="602d7-149">Handling expected errors</span></span>

<span data-ttu-id="602d7-150">アプリケーションはすべてのエラー応答 (400 および 500 の範囲) を処理する必要がありますが、次の表に示す、予想される特定のエラーと応答に特に注意を払う必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-150">While your application should handle all error responses (in the 400 and 500 ranges), pay special attention to certain expected errors and responses, listed in the following table.</span></span>

| <span data-ttu-id="602d7-151">トピック</span><span class="sxs-lookup"><span data-stu-id="602d7-151">Topic</span></span>   | <span data-ttu-id="602d7-152">HTTP エラー コード</span><span class="sxs-lookup"><span data-stu-id="602d7-152">HTTP Error Code</span></span>    | <span data-ttu-id="602d7-153">ベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="602d7-153">Best practice</span></span>|
|:-----------|:--------|:----------|
| <span data-ttu-id="602d7-154">ユーザーにアクセス権がありません</span><span class="sxs-lookup"><span data-stu-id="602d7-154">User does not have access</span></span> | <span data-ttu-id="602d7-155">403</span><span class="sxs-lookup"><span data-stu-id="602d7-155">403 Forbidden</span></span> | <span data-ttu-id="602d7-156">アプリケーションが起動して実行している場合、同意エクスペリエンスで必要なアクセス許可を与えられていても、このエラーが発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="602d7-156">If your application is up and running, it could encounter this error even if it has been granted the necessary permissions through a consent experience.</span></span>  <span data-ttu-id="602d7-157">この場合、最も考えられるのは、要求されたリソースにアクセスする権限を、サインインしているユーザーが持っていないことです。</span><span class="sxs-lookup"><span data-stu-id="602d7-157">In this case, it's most likely that the signed-in user does not have privileges to access the resource requested.</span></span> <span data-ttu-id="602d7-158">アプリケーションは、サインインしているそのユーザーに、汎用の「アクセスが拒否されました」というエラーを返す必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-158">Your application should provide a generic "Access denied" error back to the signed-in user.</span></span> |
|<span data-ttu-id="602d7-159">見つかりません</span><span class="sxs-lookup"><span data-stu-id="602d7-159">Not Found</span></span>| <span data-ttu-id="602d7-160">404</span><span class="sxs-lookup"><span data-stu-id="602d7-160">404</span></span> | <span data-ttu-id="602d7-161">場合によっては、要求されたリソースが検出できないことがあります。</span><span class="sxs-lookup"><span data-stu-id="602d7-161">In certain cases, a requested resource might not be found.</span></span> <span data-ttu-id="602d7-162">たとえば、リソースが存在しない、プロビジョニングが済んでいない (ユーザーの写真など)、削除されているなどのケースが考えられます。</span><span class="sxs-lookup"><span data-stu-id="602d7-162">For example a resource might not exist, because it has not yet been provisioned (like a user's photo) or because it has been deleted.</span></span> <span data-ttu-id="602d7-163">削除された一部のリソース (ユーザー、グループ、アプリケーション リソースなど) は、削除から 30 日以内であれば完全に復元される*可能性*があるため、アプリケーションはこの点も考慮に入れる必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-163">Some deleted resources *might* be fully restored within 30 days of deletion - such as user, group and application resources, so your application should also take this into account.</span></span>|
|<span data-ttu-id="602d7-164">スロットル</span><span class="sxs-lookup"><span data-stu-id="602d7-164">Throttling</span></span>|<span data-ttu-id="602d7-165">429</span><span class="sxs-lookup"><span data-stu-id="602d7-165">429</span></span>|<span data-ttu-id="602d7-166">API は、さまざまな理由から常にスロットルと呼ばれる状態になる可能性があります。このため、アプリケーションは**常に** 429 応答を処理できるようにしておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-166">APIs might throttle at any time for a variety of reasons, so your application must **always** be prepared to handle 429 responses.</span></span> <span data-ttu-id="602d7-167">このエラー応答には、*Retry-After* フィールドが HTTP 応答ヘッダーに格納されています。</span><span class="sxs-lookup"><span data-stu-id="602d7-167">The failed response includes the *Retry-After* field in the response header.</span></span> <span data-ttu-id="602d7-168">*Retry-After* の延期期間を使用して要求を一旦取り消すことが、最も迅速にスロットルを解消する方法です。</span><span class="sxs-lookup"><span data-stu-id="602d7-168">Backing off requests using the *Retry-After* delay is the fastest way to recover from throttling because Microsoft Graph continues to log resource usage while a client is being throttled.</span></span> <span data-ttu-id="602d7-169">詳細については、「[スロットル](throttling.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="602d7-169">For more information, see [NextRecordset](throttling.md).</span></span>|
|<span data-ttu-id="602d7-170">サービスを使用できません</span><span class="sxs-lookup"><span data-stu-id="602d7-170">Service Unavailable</span></span>| <span data-ttu-id="602d7-171">503</span><span class="sxs-lookup"><span data-stu-id="602d7-171">HTTP 503</span></span> | <span data-ttu-id="602d7-172">サービスが使用中の可能性があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-172">This is likely because the services is busy.</span></span> <span data-ttu-id="602d7-173">429 と同様に、要求を一旦取り消す方法を採用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-173">You should employ a back-off strategy similar to 429.</span></span> <span data-ttu-id="602d7-174">さらに、新しい HTTP 接続経由で再試行要求を新たに作成することが**常に**必要です。</span><span class="sxs-lookup"><span data-stu-id="602d7-174">Additionally, you should **always** make new retry requests over a new HTTP connection.</span></span>|

### <a name="evolvable-enums"></a><span data-ttu-id="602d7-175">Evolvable 列挙型</span><span class="sxs-lookup"><span data-stu-id="602d7-175">Evolvable enums</span></span>

<span data-ttu-id="602d7-176">クライアント アプリケーションは、既存の列挙型にメンバーを追加することで分割される場合があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-176">Client applications can be broken by the addition of members to an existing enum.</span></span> <span data-ttu-id="602d7-177">Microsoft Graph の新しい列挙型の一部では、重大な変更を加えずに新規メンバーを追加できるようにするメカニズムが用意されています。</span><span class="sxs-lookup"><span data-stu-id="602d7-177">For some newer enums in Microsoft Graph, a mechanism is available to allow for adding new members without incurring a breaking change.</span></span> <span data-ttu-id="602d7-178">これらの新しい列挙型では、`unknownFutureValue` と呼ばれる共通の*標識*メンバーにより、既知の列挙型メンバーと不明な列挙型メンバーが区別されます。</span><span class="sxs-lookup"><span data-stu-id="602d7-178">On these newer enums, you'll see a common *sentinel* member called `unknownFutureValue` that demarcates known and unknown enum members.</span></span> <span data-ttu-id="602d7-179">既知のメンバーにはこの標識メンバーより小さい値が指定され、不明なメンバーには大きな値が指定されます。</span><span class="sxs-lookup"><span data-stu-id="602d7-179">Known members will have a number less than the sentinel member, while unknown members will be greater in value.</span></span>
<span data-ttu-id="602d7-180">既定では、Microsoft Graph は不明なメンバーを返しません。</span><span class="sxs-lookup"><span data-stu-id="602d7-180">By default, unknown members are not returned by Microsoft Graph.</span></span> <span data-ttu-id="602d7-181">アプリケーションが不明なメンバーを処理するように作成されている場合、HTTP *Prefer* 要求ヘッダーを使用して不明な列挙型メンバーを受け取るようにオプトインできます。</span><span class="sxs-lookup"><span data-stu-id="602d7-181">If, however, your application is written to handle the appearance of unknown members, it can opt-in to receive unknown enum members, using an HTTP *Prefer* request header.</span></span>

><span data-ttu-id="602d7-182">**注:** アプリケーションが不明なメンバーを処理できるようになっている場合、次のように HTTP *prefer* 要求ヘッダーを使用してオプトインする必要があります。`Prefer: include-unknown-enum-members`。</span><span class="sxs-lookup"><span data-stu-id="602d7-182">**Note:** If your application is prepared to handle unknown enum members, it should opt-in by using an HTTP *prefer* request header: `Prefer: include-unknown-enum-members`.</span></span>

## <a name="storing-data-locally"></a><span data-ttu-id="602d7-183">ローカルにデータを保存する</span><span class="sxs-lookup"><span data-stu-id="602d7-183">Storing data locally</span></span>

<span data-ttu-id="602d7-184">アプリケーションは、Microsoft Graph に対して呼び出しを実行し、必要に応じてリアルタイムでデータを取得するのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="602d7-184">Your application should ideally make calls to Microsoft Graph to retrieve data in real time as necessary.</span></span> <span data-ttu-id="602d7-185">特定のシナリオに必要な場合に限って、データをローカルにキャッシュし保存するようにします。そのようなユース ケースが使用条件やプライバシー ポリシーの対象となっている場合は、[Microsoft Graph の利用規約](../misc/terms-of-use.md)に違反しないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-185">You should only cache or store data locally if required for a specific scenario, and if that use case is covered by your terms of use and privacy policy, and does not violate the [Microsoft Graph terms of use](../misc/terms-of-use.md).</span></span> <span data-ttu-id="602d7-186">適切な保持ポリシーと削除ポリシーをアプリケーションに実装する必要もあります。</span><span class="sxs-lookup"><span data-stu-id="602d7-186">Your application should also implement proper retention and deletion policies.</span></span>

## <a name="optimizations"></a><span data-ttu-id="602d7-187">最適化</span><span class="sxs-lookup"><span data-stu-id="602d7-187">Optimizations</span></span>

<span data-ttu-id="602d7-188">一般に、パフォーマンス、セキュリティ、プライバシー保護などの理由から、アプリケーションが本当に必要とするデータのみを取得するようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-188">In general, for performance and even security or privacy reasons, you should only get the data your application really needs, and nothing more.</span></span>

### <a name="use-projections"></a><span data-ttu-id="602d7-189">使用予測</span><span class="sxs-lookup"><span data-stu-id="602d7-189">Use projections</span></span>

<span data-ttu-id="602d7-190">アプリケーションで本当に必要となるプロパティのみを選択します。これにより、不要なネットワーク トラフィックだけでなく、アプリケーション (やサービス) での不要なデータ処理を削減できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-190">Choose only the properties your application really needs and no more, because this saves unnecessary network traffic and data processing in your application (and in the service).</span></span>

><span data-ttu-id="602d7-191">**注:** クエリから返されるプロパティをアプリケーションで必要なものだけに制限するには、`$select` クエリ パラメーターを使用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-191">**Note:** Use the `$select` query parameter to limit the properties returned by a query to those needed by your application.</span></span>

<span data-ttu-id="602d7-192">たとえば、サインイン ユーザーのメッセージを取得するとき、**from** プロパティと **subject** プロパティだけを返すよう指定できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-192">For example, when retrieving the messages of the signed-in user, you can specify that only the **from** and **subject** properties be returned:</span></span>

```http
GET https://graph.microsoft.com/v1.0/me/messages?$select=from,subject
```

### <a name="getting-minimal-responses"></a><span data-ttu-id="602d7-193">最低限の応答を取得する</span><span class="sxs-lookup"><span data-stu-id="602d7-193">Getting minimal responses</span></span>

<span data-ttu-id="602d7-194">PUT、PATCH (および一部の POST) などのいくつかの操作では、アプリケーションで応答ペイロードを利用する必要がない場合、API が最低限のデータを返すようにできます。</span><span class="sxs-lookup"><span data-stu-id="602d7-194">For some operations, such as PUT and PATCH (and in some cases POST), if your application doesn't need to make use of a response payload, you can ask the API to return minimal data.</span></span> <span data-ttu-id="602d7-195">一部のサービスでは、PUT 操作や PATCH 操作に対して既に「204 No Content」応答が返されています。</span><span class="sxs-lookup"><span data-stu-id="602d7-195">Note that some services already return a 204 No Content response for PUT and PATCH operations.</span></span>

><span data-ttu-id="602d7-196">**注:** 適切な場合は、HTTP 要求ヘッダーを次のように使用して、最低限の表示応答を要求します。*Prefer: return=minimal*。</span><span class="sxs-lookup"><span data-stu-id="602d7-196">**Note:** Request minimal representation responses using an HTTP request header where appropriate: *Prefer: return=minimal*.</span></span> <span data-ttu-id="602d7-197">ただし、作成操作ではこの処理が不適切な場合があることにご注意ください。これは、新しく作成されたオブジェクトに対してサービスで生成された `id` を、アプリケーションが応答で取得する可能性が想定されるためです。</span><span class="sxs-lookup"><span data-stu-id="602d7-197">Note that for creation operations, this might not be appropriate because your application may expect to get the service generated `id` for the newly created object in the response.</span></span>

### <a name="track-changes-delta-query-and-webhook-notifications"></a><span data-ttu-id="602d7-198">変更履歴の記録: デルタ クエリと webhook 通知</span><span class="sxs-lookup"><span data-stu-id="602d7-198">Track changes: delta query and webhook notifications</span></span>

<span data-ttu-id="602d7-199">アプリケーションでデータへの変更を認識する必要がある場合、対象データが変更されるたびに webhook 通知を取得できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-199">If your application needs to know about changes to data, you can get a webhook notification whenever data of interest has changed.</span></span> <span data-ttu-id="602d7-200">この方が、定期的にポーリングするよりも効率的です。</span><span class="sxs-lookup"><span data-stu-id="602d7-200">This is more efficient than simply polling on a regular basis.</span></span>

<span data-ttu-id="602d7-201">データが変更されたときにプッシュ通知を取得するには、[webhook 通知](../api-reference/v1.0/resources/webhooks.md)を使用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-201">Use [webhook notifications](../api-reference/v1.0/resources/webhooks.md) to get push notifications when data changes.</span></span>

<span data-ttu-id="602d7-202">アプリケーションで Microsoft Graph データをローカルにキャッシュまたは保存し、そのデータを常に最新の状態に保ったり、何らかの理由でデータへの変更履歴を記録したりする必要がある場合は、デルタ クエリを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-202">If your application is required to cache or store Microsoft Graph data locally, and keep that data up to date, or track changes to data for any other reasons, you should use delta query.</span></span> <span data-ttu-id="602d7-203">これにより、アプリケーションが既に持っているデータを取得するために過剰な計算を行う必要がなくなり、ネットワーク トラフィックを最小化し、スロットルのしきい値に到達しにくくできます。</span><span class="sxs-lookup"><span data-stu-id="602d7-203">This will avoid excessive computation by your application to retrieve data your application already has, minimize network traffic, and reduce the likelihood of reaching a throttling threshold.</span></span>

<span data-ttu-id="602d7-204">効率よくデータを最新の状態に保つには、[デルタ クエリ](delta_query_overview.md)を使用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-204">Use [delta query](delta_query_overview.md) to efficiently keep data up to date.</span></span>

### <a name="using-webhooks-and-delta-query-together"></a><span data-ttu-id="602d7-205">webhook とデルタ クエリを組み合わせて使用する</span><span class="sxs-lookup"><span data-stu-id="602d7-205">Using webhooks and delta query together</span></span>

<span data-ttu-id="602d7-206">多くの場合、webhook とデルタ クエリを組み合わせて使用する方がさらに優れています。デルタ クエリのみを使用する場合、適切なポーリング間隔を見つける必要がありますが、間隔が短すぎると空の応答が返されてリソースが浪費され、逆に間隔が長すぎるとデータが古くなりすぎる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="602d7-206">Webhooks and delta query are often used better together, because if you use delta query alone, you need to figure out the right polling interval - too short and this might lead to empty responses which wastes resources, too long and you might end up with stale data.</span></span> <span data-ttu-id="602d7-207">webhook 通知をデルタ クエリ呼び出しを実行するトリガーとして使うと、最適な結果が得られます。</span><span class="sxs-lookup"><span data-stu-id="602d7-207">If you use webhook notifications as the trigger to make delta query calls, you get the best of both worlds.</span></span>

<span data-ttu-id="602d7-208">[webhook 通知](../api-reference/v1.0/resources/webhooks.md)を、デルタ クエリ呼び出しを実行するトリガーとして使用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-208">Use [webhook notifications](../api-reference/v1.0/resources/webhooks.md) as the trigger to make delta query calls.</span></span> <span data-ttu-id="602d7-209">通知がトリガーされない場合に備えて、バックストップ ポーリングしきい値をアプリケーションに指定しておく必要もあります。</span><span class="sxs-lookup"><span data-stu-id="602d7-209">You should also ensure that your application has a backstop polling threshold, in case no notifications are triggered.</span></span>

### <a name="batching"></a><span data-ttu-id="602d7-210">バッチ処理</span><span class="sxs-lookup"><span data-stu-id="602d7-210">Batching</span></span>

<span data-ttu-id="602d7-211">JSON のバッチ処理を使用すると、複数の要求を単一の JSON オブジェクトに統合することにより、アプリケーションを最適化することができます。</span><span class="sxs-lookup"><span data-stu-id="602d7-211">JSON batching allows you to optimize your application by combining multiple requests into a single JSON object. For example, a client might want to compose a view of unrelated data such as:</span></span> <span data-ttu-id="602d7-212">それぞれの要求を 1 つのバッチ要求にまとめることで、アプリケーションのネットワーク待機時間を大きく削減し、接続リソースを節約することができます。</span><span class="sxs-lookup"><span data-stu-id="602d7-212">Combining these three individual requests into a single batch request can save the application significant network latency.</span></span>

<span data-ttu-id="602d7-213">大幅なネットワーク待機時間がパフォーマンスに大きな影響を及ぼす可能性がある場合、[バッチ処理](json_batching.md)を使用します。</span><span class="sxs-lookup"><span data-stu-id="602d7-213">Use [batching](json_batching.md) where significant network latency can have a big impact on the performance.</span></span>

## <a name="reliability-and-support"></a><span data-ttu-id="602d7-214">信頼性とサポート</span><span class="sxs-lookup"><span data-stu-id="602d7-214">Reliability and support</span></span>
<span data-ttu-id="602d7-215">アプリケーションの信頼性を確保しサポートを容易にするには、次のようにします。</span><span class="sxs-lookup"><span data-stu-id="602d7-215">To ensure reliability and facilitate support for your application:</span></span>

- <span data-ttu-id="602d7-216">DNS TTL を優先し、接続 TTL をそれに合わせて設定します。</span><span class="sxs-lookup"><span data-stu-id="602d7-216">Honor DNS TTL and set connection TTL to match it.</span></span> <span data-ttu-id="602d7-217">これにより、フェールオーバーの際の可用性を確保できます。</span><span class="sxs-lookup"><span data-stu-id="602d7-217">This ensures availability in case of failovers.</span></span>
- <span data-ttu-id="602d7-218">アドバタイズされたすべての DNS 応答に対して接続を開きます。</span><span class="sxs-lookup"><span data-stu-id="602d7-218">Open connections to all advertised DNS answers.</span></span>
- <span data-ttu-id="602d7-219">HTTP 応答ヘッダーの *request-id* と *timestamp* は常にログします。</span><span class="sxs-lookup"><span data-stu-id="602d7-219">Always log the *request-id* and *timestamp* from the HTTP response header.</span></span> <span data-ttu-id="602d7-220">これは、Stack Overflow や Microsoft カスタマー サポートで問題をエスカレーションしたりレポートしたりする際に必要になります。</span><span class="sxs-lookup"><span data-stu-id="602d7-220">This is required when escalating issues or reporting issues in Stack Overflow or to Microsoft Customer Support.</span></span>
