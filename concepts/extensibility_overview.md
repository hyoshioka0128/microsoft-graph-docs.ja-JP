# <a name="add-custom-data-to-resources-using-extensions"></a>拡張機能を使用してカスタム データをリソースに追加する

Microsoft Graph は、[ユーザー](../api-reference/beta/resources/user.md)および[メッセージ](../api-reference/beta/resources/message.md)などの数多くのリソースを通じて、多様なユーザー中心のデータと分析情報にアクセスするための単一の API エンドポイントを提供します。独自のアプリケーション データを使用して Microsoft Graph を_**拡張**_する方法を現在提供しています。Microsoft Graph リソースに対して、外部のデータ ストアを必要とせずに、カスタム プロパティを追加できます。たとえば、**ユーザー** リソースを拡張することによって、アプリを軽量に保ちながら、アプリ固有のユーザー プロファイル データを Microsoft Graph に格納できます。または、アプリの既存のユーザー プロファイル ストアを保持し、**ユーザー** リソースにアプリ固有のストア識別子を追加することもできます。

Microsoft Graph には、2 種類の拡張機能が備わっています。ご自分のアプリケーションの必要に最適な拡張機能の種類を選択してください。

*  **オープン拡張機能**:開発者が使用するのに適しています。
*  **スキーマ拡張機能**:型指定されたデータを格納すること、スキーマの検出と共有を容易にすること、フィルターを可能にすること、将来、入力データの検証と承認を可能にすることに関心のある開発者にとって、用途のより広いメカニズムとなります。

>**重要:**拡張機能は、アカウント資格情報、政府による識別番号、カード名義人データ、財務会計データ、医療情報、機密性のある背景情報などの個人を特定できる機密情報を格納するために使用すべきではありません。

## <a name="supported-resources"></a>サポートされているリソース

次の表に、オープン拡張機能とスキーマ拡張機能に関する現在のサポート情報、および、一般提供可能 (GA /v1.0 および /ベータ) とプレビューのみ (/ベータ) のどちらであるかを示します。 

| リソース | オープン拡張機能 | スキーマ拡張機能 |
|---------------|-------|-------|
| [管理単位](../api-reference/beta/resources/administrativeunit.md) | プレビューのみ | 近日公開 |
|  [予定表イベント](../api-reference/beta/resources/event.md) | GA | プレビューのみ |
|  [予定表イベント](../api-reference/beta/resources/event.md)のグループ化 | GA | プレビューのみ |
|  会話スレッド[投稿](../api-reference/beta/resources/post.md)のグループ化 | GA | プレビューのみ |
|  [デバイス](../api-reference/beta/resources/device.md) | プレビューのみ | プレビューのみ |
|  [グループ](../api-reference/beta/resources/group.md) | プレビューのみ | プレビューのみ |
|  [メッセージ](../api-reference/beta/resources/message.md) | GA | プレビューのみ |
|  [組織](../api-reference/beta/resources/organization.md) | プレビューのみ | 近日公開 |
|  [個人用連絡先](../api-reference/beta/resources/contact.md)| GA | 近日公開 |
|  [ユーザー](../api-reference/beta/resources/user.md) | プレビューのみ | プレビューのみ |

## <a name="open-extensions"></a>オープン拡張機能
[オープン拡張機能](../api-reference/beta/resources/opentypeextension.md) (以前の Office 365 データ拡張機能) は、[オープン タイプ](http://www.odata.org/getting-started/advanced-tutorial/#openType)であり、型指定されていないアプリ データを直接リソース インスタンスに追加するための柔軟な方法を提供します。 

オープン拡張機能は、カスタム データとともに、リソース インスタンスの**拡張機能**ナビゲーション プロパティを介してアクセスできます。オープン拡張機能で_事前に定義される_書き込み可能なプロパティは、**extensionName** プロパティだけです。オープン拡張機能を作成する場合、**extensionName** プロパティにテナント内で一意の名前を割り当てる必要があります。これを行う方法の 1 つは、_独自のドメイン_に依存する逆引きドメイン ネーム システム (DNS) 形式 (例: `Com.Contoso.ContactInfo`) を使用することです。拡張機能名に Microsoft ドメイン (`Com.Microsoft` または `Com.OnMicrosoft`) を使用しないでください。

リソース インスタンスに[オープン拡張機能を作成](../api-reference/beta/api/opentypeextension_post_opentypeextension.md)し、すべてのカスタム データを同じ操作で保存することができます (サポートされているリソースの一部については、[以下の既知の制限](#known-limitations-for-extensions)を参照してください)。その後、拡張機能とそのデータの[読み取り](../api-reference/beta/api/opentypeextension_get.md)、[更新](../api-reference/beta/api/opentypeextension_update.md)、または[削除](../api-reference/beta/api/opentypeextension_delete.md)を行うことができます。 

>**注:**オープン拡張機能は、イベント、グループの投稿、メッセージ、および個人の連絡先に対して一般公開 (GA) されています。管理単位、デバイス、グループ、組織、ユーザーにもプレビューでオープン拡張機能を使用できるようになりました。

オープン拡張機能の例:[オープン拡張機能を使用したユーザーへのカスタム データの追加 (プレビュー)](extensibility_open_users.md)

## <a name="schema-extensions-preview"></a>スキーマ拡張機能 (プレビュー)
[スキーマ拡張](../api-reference/beta/resources/schemaextension.md)を使用すると、リソースの種類の拡張に使用するスキーマを定義できます。最初に、スキーマ拡張機能の定義を作成します。次に、それを使用して厳密に型指定されたカスタム データを含むリソース インスタンスを拡張します。さらに、スキーマ拡張機能の[状態](#schema-extensions-lifecycle)を制御し、他のアプリで検出できるようにすることができます。これらのアプリは自身のデータの拡張機能を使用して、その上にさらにエクスペリエンスを構築できます。

スキーマ拡張機能定義を作成する場合、その **id** の一意の名前を指定する必要があります。次の 2 つの名前付けオプションがあります。

- ご使用のテナントで検証済みのバニティ `.com` ドメインが既にある場合、ドメイン名とスキーマ名を一緒に使用して一意の名前を定義できます (形式: \{_&#65279;domainName_\}\_\{_&#65279;schemaName_\})。たとえば、バニティ ドメインが contoso.com の場合、**id** を `contoso_mySchema` と定義できます。これは優先オプションです。
- 検証済みバニティ ドメインがない場合、**id** をスキーマ名 (ドメイン名のプレフィックスなし) に設定できます (例: `mySchema`)。Microsoft Graph によって、指定した名前に基づいて文字列 ID が割り当てられます (形式: ext\{_&#65279;8-random-alphanumeric-chars_\}\_\{_&#65279;schema-name_\})。例: `extkvbmkofy_mySchema`。

この一意の名前は、拡張リソース インスタンスにカスタム データを格納する複合型の名前として使用される **id** に示されます。 


オープン拡張機能とは異なり、スキーマ拡張機能の定義 ([リスト](../api-reference/beta/api/schemaextension_list.md)、[作成](../api-reference/beta/api/schemaextension_post_schemaextensions.md)、[取得](../api-reference/beta/api/schemaextension_get.md)、[更新](../api-reference/beta/api/schemaextension_update.md)、および[削除](../api-reference/beta/api/schemaextension_delete.md)) とそのデータ (データの追加、取得、更新、および削除) の管理は異なるセットの API 操作になっています。 

スキーマ拡張機能は、対象となるリソースのインスタンスで複合型としてアクセス可能であるため、次の方法を使用してスキーマ拡張機能でデータの CRUD 操作を行うことができます。

- リソース `POST` メソッドを使用して、新しいリソース インスタンスを作成するときにカスタム データを指定できます。
- リソース `GET` メソッドを使用して、カスタム データを読み取ることができます。
- リソース `PATCH` メソッドを使用して、既存のリソース インスタンスでカスタム データを追加または更新できます。
- リソース `PATCH` メソッドを使用して、複合型を null に設定し、リソース インスタンスのカスタム データを削除できます。 

スキーマ拡張機能の例:[スキーマ拡張機能を使用したグループへのカスタム データの追加 (プレビュー)](extensibility_schema_groups.md)


### <a name="schema-extensions-lifecycle"></a>スキーマ拡張機能のライフサイクル
アプリによってスキーマ拡張機能定義が作成されると、そのアプリがスキーマ拡張機能の所有者としてマークされます。 

所有者アプリは、**ステータス** プロパティで PATCH 操作を使用して、拡張機能をさまざまな状態のライフサイクル間で移動できます。所有者アプリは現在の状態に応じて、拡張機能を更新または削除することができます。スキーマ拡張機能の更新は常に、付加的で中断を必要としない更新でなければなりません。


| State | ライフ サイクル状態の動作 |
|-------------|------------|
| InDevelopment | - 作成後の初期状態です。所有者アプリは引き続きスキーマ拡張機能を開発しています。 <br> - この状態では、所有者アプリのみがスキーマ拡張機能を使用できます。所有者アプリは、付加的な変更で拡張機能の定義を更新したり、拡張機能を削除したりできます。所有者アプリがリソース インスタンスを拡張できるのは、このスキーマ定義を使用して、所有者アプリが登録されているのと同じディレクトリ内にある場合のみです。 <br> - 所有者アプリは拡張機能を `InDevelopment` から `Available` の状態に移行できます。 |
| Available | - スキーマ拡張機能は、テナント内のすべてのアプリで利用できます。 <br> - 所有者アプリで拡張子を `Available` に設定すると、すべてのアプリは、拡張機能で指定されているこれらのリソースの種類のインスタンスにカスタム データを追加できます (アプリにそのリソースへのアクセス許可がある場合)。アプリは、新しいインスタンスの作成時、または既存のインスタンスの更新時にカスタム データを割り当てることができます。所有者アプリだけが、付加的な変更で拡張機能の定義を更新したり、拡張機能を削除したりできます。 <br> - 所有者アプリはスキーマ拡張機能を `Available` から `Deprecated` の状態に移行することもできます。 |
| Deprecated | - スキーマ拡張機能の定義の読み取りまたは変更はできなくなります。 <br> - どのアプリも、新しいプロパティを表示、更新、追加したり、拡張機能を削除したりすることはできません。ただし、拡張機能の_プロパティ値_の読み取り、更新、または削除は引き続き行えます。 <br> - 所有者アプリはスキーマ拡張機能を `Deprecated` から `Available` の状態に戻すことができます。 |

>**注:**`Deprecated` 状態のスキーマ拡張機能では、引き続きカスタム データを削除したり、またはカスタム データにアクセスしたりすることができます。ただし、現在、スキーマ拡張機能を削除した後にカスタム データにアクセスできなくなるという[既知の問題](#known-limitations-for-extensions)があります。

### <a name="supported-property-data-types"></a>サポート対象のプロパティ データ型 
スキーマ拡張機能でプロパティを定義する場合、次のデータ型がサポートされています。

| プロパティの種類 | 注釈 |
|-------------|------------|
| Binary | 最大 256 バイトです。 |
| Boolean | メッセージ、イベント、投稿ではサポートされていません。 |
| DateTime | ISO 8601 形式で指定する必要があります。UTC で格納されます。 |
| 整数 | 32 ビット値です。メッセージ、イベント、投稿ではサポートされていません。 |
| String | 最大 256 文字です。 |

>**注:**現在、複数値プロパティはサポートされていません。

### <a name="azure-ad-directory-schema-extensions"></a>Azure AD ディレクトリのスキーマ拡張機能
Azure AD は、いくつかの [directoryObject](../api-reference/beta/resources/directoryObject.md) リソースで、[ディレクトリ スキーマ拡張機能](https://msdn.microsoft.com/en-us/library/azure/ad/graph/howto/azure-ad-graph-api-directory-schema-extensions)と呼ばれる、同様の拡張機能をサポートしています。Azure AD Graph API を使用して、ディレクトリ スキーマ拡張機能の定義を作成および管理する必要がある場合でも、Microsoft Graph API を使用して、これらの拡張機能のプロパティの_データ_を追加、取得、更新、および削除することができます。

## <a name="permissions"></a>アクセス許可
特定のリソース上の拡張機能データに対して読み書きするには、そのリソースに対して読み書きするときに必要となるのと同じ[アクセス許可](../authorization/permission_scopes.md)が必要になります。たとえば、サインイン済みのユーザーのプロファイルをカスタム アプリ データで更新できるようにするには、アプリに *User.ReadWrite.All* アクセス許可を付与しておく必要があります。

また、スキーマ拡張機能定義を作成および管理できるようにするには、アプリケーションに *Directory.AccessAsUser.All* アクセス許可を付与しておく必要があります。
 
## <a name="known-limitations-for-extensions"></a>拡張機能に関する既知の制限
-   **管理単位**、**デバイス**、**グループ**、**組織**、または**ユーザー**のインスタンスを作成するのと同時に、オープン拡張機能を指定することはできません。最初にインスタンスを作成し、次にそのインスタンスの後続の ``POST`` 要求でオープン拡張機能データを指定する必要があります。  
-   変更の追跡 (デルタ クエリ) はオープン拡張機能とスキーマ拡張機能のどちらのプロパティでもサポートされていません。
-   現時点では、スキーマ拡張機能のプロパティ値のフィルター処理はサポートされていません (間もなく利用できるようになる予定です)。
-   スキーマ拡張機能定義を削除すると、削除されたスキーマに基づいて追加されたカスタム データすべてに対するアクセスも削除されます。これは、一時的な制限です。
-   現在、すべての状態においてスキーマ拡張機能の削除が可能です。将来、削除を行えるのは `InDevelopment` 状態のスキーマ拡張機能のみになる予定です。
-   リソース インスタンスからスキーマ拡張機能複合型を削除するには、すべての複合型のプロパティ値を `null` に設定しなければなりません。将来は、スキーマ拡張機能複合型を `null` に設定するだけで削除できるようになる予定です。
-   現在、ユーザー、グループ、デバイスなどのディレクトリ リソースでは、1 つのリソースで設定可能なスキーマ拡張機能のプロパティ値の合計数が 100 に制限されています。

## <a name="extension-examples"></a>拡張機能の例
[オープン拡張機能を使用したユーザーへのカスタム データの追加 (プレビュー)](extensibility_open_users.md)

[スキーマ拡張機能を使用したグループへのカスタム データの追加 (プレビュー)](extensibility_schema_groups.md)

## <a name="see-also"></a>関連項目

[Office 365 のドメイン](https://technet.microsoft.com/en-us/library/office-365-domains.aspx)

[Office 365 テナントのドメインの追加および検証](http://office365support.ca/adding-and-verifying-a-domain-for-the-new-office-365/)
