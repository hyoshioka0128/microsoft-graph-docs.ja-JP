# <a name="get-started-with-microsoft-graph-in-a-python-app"></a><span data-ttu-id="2dc26-101">Python アプリで Microsoft Graph を使ってみる</span><span class="sxs-lookup"><span data-stu-id="2dc26-101">Get started with Microsoft Graph in a Python app</span></span> 

<span data-ttu-id="2dc26-102">この記事では、Azure AD からアクセス トークンを取得し、Microsoft Graph を呼び出すために必要なタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-102">This article describes the tasks required to get an access token from the v2.0 authentication endpoint and call  Microsoft Graph.</span></span> <span data-ttu-id="2dc26-103">ここでは、[Python から Microsoft Graph を介してメールを送信する](https://github.com/microsoftgraph/python-sample-send-mail)ためのチュートリアルと、Microsoft Graph API を使用するために実装する主要な概念について説明します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-103">It walks you through [Sending mail via Microsoft Graph from Python](https://github.com/microsoftgraph/python-sample-send-mail) and explains the main concepts that you implement to use the Microsoft Graph API.</span></span> <span data-ttu-id="2dc26-104">直接 REST 呼び出しを使用して Microsoft Graph にアクセスする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-104">The article also describes how to access Microsoft Graph by using REST calls.</span></span>

![[メールの送信] フォーム](https://raw.githubusercontent.com/microsoftgraph/python-sample-send-mail/master/static/images/sendmail.png)

## <a name="choosing-an-authentication-library"></a><span data-ttu-id="2dc26-106">認証ライブラリの選択</span><span class="sxs-lookup"><span data-stu-id="2dc26-106">Choosing an authentication library</span></span>

<span data-ttu-id="2dc26-107">Microsoft Graph を呼び出すには、Microsoft クラウドの ID サービスである Azure Active Directory (Azure AD) から有効なアクセス トークンをアプリが取得し、そのトークンが Microsoft Graph REST API に対する各呼び出しの HTTP ヘッダーに渡される必要があります。</span><span class="sxs-lookup"><span data-stu-id="2dc26-107">To make calls to Microsoft Graph, your app must obtain a valid access token from Azure Active Directory (Azure AD), the Microsoft cloud identity service, and the token must be passed in an HTTP header with each call to the Microsoft Graph REST API.</span></span> <span data-ttu-id="2dc26-108">Graph での認証方法は OAuth 2.0 と Open ID Connect 標準に基づいているため、アプリケーションで認証を実装するために選択可能な[認証ライブラリ](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries)が多数存在します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-108">Graph's approach to authentication is based on the OAuth 2.0 and Open ID Connect standards, so there are many [authentication libraries](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries) that you can choose from to implement authentication in your application.</span></span>

<span data-ttu-id="2dc26-109">以下に取り上げられているサンプルでは、[Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) ライブラリを使用して OAuth 2.0 [認証コードの付与](https://tools.ietf.org/html/rfc6749#section-4.1)ワークフローを実装しています。これは、Python で書かれた Web アプリケーションで推奨されている認証ワークフローです。</span><span class="sxs-lookup"><span data-stu-id="2dc26-109">The sample covered below uses the [Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) library to implement OAuth 2.0 [Authorization Code Grant](https://tools.ietf.org/html/rfc6749#section-4.1) workflow, which is the recommended auth workflow for web applications written in Python.</span></span> <span data-ttu-id="2dc26-110">その他の認証オプションについては、「[Microsoft Graph 用の Python 認証サンプル](https://github.com/microsoftgraph/python-sample-auth)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-110">For information about other authentication options, see [Python authentication samples for Microsoft Graph](https://github.com/microsoftgraph/python-sample-auth).</span></span>

## <a name="installing-and-running-the-send-mail-sample"></a><span data-ttu-id="2dc26-111">メールの送信サンプルのインストールと実行</span><span class="sxs-lookup"><span data-stu-id="2dc26-111">Installing and running the send-mail sample</span></span>

<span data-ttu-id="2dc26-112">サンプル アプリをインストールして構成するには、「[Python REST サンプルのインストール](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md)」に記されている説明に従います。</span><span class="sxs-lookup"><span data-stu-id="2dc26-112">To install and configure the sample app, follow the instructions in [Installing the Python REST samples](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md).</span></span> <span data-ttu-id="2dc26-113">以下で取り上げられているメールの送信サンプル用に、次のコマンドを使用してリポジトリを複製します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-113">For the send-mail sample covered below, use this command to clone the repo:</span></span>

    ```git clone https://github.com/microsoftgraph/python-sample-send-mail.git```

<span data-ttu-id="2dc26-114">[インストール手順](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md)に記されているように、アプリケーションを登録する際、このサンプルに必要な **User.Read** アクセス許可と **Mail.Send** アクセス許可を必ず含めてください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-114">When you register the application as covered in the [installation instructions](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md), be sure to include the **User.Read** and **Mail.Send** permissions, which are required for this sample.</span></span>

<span data-ttu-id="2dc26-115">インストールと構成の完了後、[サンプルの実行](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample)に関する説明に従ってサンプル アプリを実行できます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-115">After completing the installation/configuration, you can run the sample app by following the instructions for [running the sample](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample).</span></span>

## <a name="code-walkthrough"></a><span data-ttu-id="2dc26-116">コードのチュートリアル</span><span class="sxs-lookup"><span data-stu-id="2dc26-116">Code walkthrough</span></span>

<span data-ttu-id="2dc26-117">サンプル アプリの[ソース コード](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py)に関する概要を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-117">The following is an overview of the [source code](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py) for the sample app.</span></span>

<span data-ttu-id="2dc26-118">コードの最初の数行は、サンプルで使用される Python のモジュールとパッケージの [import](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L11) です。</span><span class="sxs-lookup"><span data-stu-id="2dc26-118">The first few lines of code are the [imports](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L11) for the Python modules and packages used in the sample:</span></span>

* <span data-ttu-id="2dc26-119">標準ライブラリからの **base64** モジュールは、電子メール添付ファイルのエンコードに使用します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-119">The **base64** module from the standard library is used for encoding email attachments.</span></span>
* <span data-ttu-id="2dc26-120">標準ライブラリからの **pprint** モジュールは、Graph が返すエラー メッセージを整形出力するのに使用します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-120">The **pprint** module from the standard library is used to pretty-print any error messages returned by Graph.</span></span> <span data-ttu-id="2dc26-121">(たとえば、無効な電子メール アドレスに送信する場合。) </span><span class="sxs-lookup"><span data-stu-id="2dc26-121">(For example, if you try to send to an invalid email address.)</span></span>
* <span data-ttu-id="2dc26-122">標準ライブラリからの **uuid** モジュールは、各 Graph 要求を一意に識別する 36 文字で構成される文字列をランダムに生成するのに使用します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-122">The **uuid** module from the standard library is used to generate a random 36-character string to uniquely identify each Graph request.</span></span> <span data-ttu-id="2dc26-123">これは、デバッグに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-123">This can be useful for debugging purposes.</span></span>
* <span data-ttu-id="2dc26-124">**flask** パッケージは、サンプル用の Web フレームワークです。</span><span class="sxs-lookup"><span data-stu-id="2dc26-124">The **flask** package is the web framework for the sample.</span></span>
* <span data-ttu-id="2dc26-125">**flask_oauthlib.client** の **OAuth** クラスは、OAuth 2.0 認証ワークフローを実装する Flask アプリを包含するラッパーです。</span><span class="sxs-lookup"><span data-stu-id="2dc26-125">The **OAuth** class of **flask_oauthlib.client** is a wrapper around the Flask app that implements the OAuth 2.0 authentication workflow.</span></span>
* <span data-ttu-id="2dc26-126">**config** モジュールには、アプリケーション登録設定 (前述のインストール プロセスで構成した設定など) が含まれます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-126">The **config** module contains the application registration settings, as configured in the installation process above.</span></span>

<span data-ttu-id="2dc26-127">次に、[Flask アプリを作成](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L13-L15)してから、**MSGRAPH** という名前の [Graph クライアント オブジェクト](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L17-L26)を作成します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-127">Next, we [create a Flask app](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L13-L15) and then create the [Graph client object](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L17-L26), named **MSGRAPH**.</span></span>

<span data-ttu-id="2dc26-128">これの初期セットアップ手順によって、認証ワークフローを実装する 3 つの Flask ルート ハンドラー関数 [homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L28-L31)、[login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L33-L37)、[authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L39-L46) が生成されます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-128">After those initial setup steps come three Flask route handler functions that implement the authentication workflow: [homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L28-L31), [login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L33-L37), and [authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L39-L46).</span></span> <span data-ttu-id="2dc26-129">この認証ワークフローの詳細については、Python 認証サンプル リポジトリの「[サンプル アーキテクチャ](https://github.com/microsoftgraph/python-sample-auth#sample-architecture)」セクションをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-129">For more information about the authentication workflow, see the [Sample architecture](https://github.com/microsoftgraph/python-sample-auth#sample-architecture) section of the Python authentication samples repo.</span></span>

<span data-ttu-id="2dc26-130">次のルート ハンドラー [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L48-L54) は、電子メールの受信者、件名、本文を指定するフォームです。</span><span class="sxs-lookup"><span data-stu-id="2dc26-130">The next route handler, [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L48-L54), is the form where you specify email recipients, subject, and body.</span></span> <span data-ttu-id="2dc26-131">なお、この関数には、Graph への最初の呼び出しも含まれ、現在のユーザーの表示名と電子メール アドレスを取得するための[ユーザー プロファイルの取り出し](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L51-L51)が含まれます。ユーザー プロファイルは [ mailform.html テンプレートに渡されます](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L52-L54)。</span><span class="sxs-lookup"><span data-stu-id="2dc26-131">Note that this function also includes our first call to Graph: [retrieving the user profile](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L51-L51) to get the current user's display name and email address, which are [passed to the mailform.html template](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L52-L54).</span></span>

<span data-ttu-id="2dc26-132">次は [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L56-L73) 関数です。この関数は、電子メールを送信し、Graph API からの応答を表示します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-132">Next is the [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L56-L73) function, which sends the email and displays the response from the Graph API.</span></span> <span data-ttu-id="2dc26-133">それは sendmail() ヘルパー関数を使用します。この関数には、フォームに入力されたクエリ文字列パラメーターが渡されます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-133">It uses a sendmail() helper function, passing to it the query string parameters that were posted from the form:</span></span>

```python
response = sendmail(MSGRAPH,
                    subject=flask.request.args['subject'],
                    recipients=flask.request.args['email'].split(';'),
                    html=flask.request.args['body'])
```

<span data-ttu-id="2dc26-134">[get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L78) 関数が Flask-OAuthlib クライアント インスタンス (```MSGRAPH```) で使用され、Graph に対する呼び出しが行われるたびにアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-134">The [get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L78) function is used by the Flask-OAuthlib client instance (```MSGRAPH```) to obtain an access token whenever we make calls to Graph.</span></span> <span data-ttu-id="2dc26-135">アクセス トークンは **Authorization** という名前の HTTP ヘッダーで渡されますが、コードでこれを処理する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="2dc26-135">The access token is passed in an HTTP header named **Authorization**, but you don't need to deal with this in your code.</span></span> <span data-ttu-id="2dc26-136">Graph への呼び出しはクライアントの HTTP verb メソッド (get()、post() など) を介して簡単に行えます。クライアント インスタンスは、トークンを取得するための ```get_token()``` の呼び出しを認識します。この関数が、```tokengetter``` で[修飾](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L75)されているためです。</span><span class="sxs-lookup"><span data-stu-id="2dc26-136">You can simply make calls to Graph via the client's HTTP verb methods (for example, get() or post()), and the client instance will know to call ```get_token()``` to obtain a token, because the function is [decorated](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L75) with ```tokengetter```.</span></span>

<span data-ttu-id="2dc26-137">次の [request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L80-L85) は、Graph への各呼び出しによって送信される HTTP ヘッダーのディクショナリを返します。</span><span class="sxs-lookup"><span data-stu-id="2dc26-137">Next comes [request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L80-L85), which returns a dictionary of HTTP headers that are sent with each call to Graph.</span></span>

<span data-ttu-id="2dc26-138">最終的に、電子メールを送信するためのヘルパー関数 [sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L87-L129) が完成しました。</span><span class="sxs-lookup"><span data-stu-id="2dc26-138">Finally we have [sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L87-L129), the helper function for sending email.</span></span> <span data-ttu-id="2dc26-139">この関数は、Microsoft Graph API で ```me/microsoft.graph.sendMail``` エンドポイントを使用してメッセージを送信します。Microsoft Graph を使用して電子メールを送信する必要がある場合に、この関数をコードでいつでも再使用できます。</span><span class="sxs-lookup"><span data-stu-id="2dc26-139">It sends a message using the ```me/microsoft.graph.sendMail``` endpoint in the Microsoft Graph API, and you can re-use this function in your own code whenever you need to send email via Microsoft Graph.</span></span> <span data-ttu-id="2dc26-140">この関数の呼び出し方法については、「[docstring](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L88-L97)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-140">See the [docstring](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L88-L97) for information about how to call this function.</span></span>

## <a name="other-python-rest-samples"></a><span data-ttu-id="2dc26-141">その他の Python REST サンプル</span><span class="sxs-lookup"><span data-stu-id="2dc26-141">Other Python REST samples</span></span>

<span data-ttu-id="2dc26-142">既に取り上げたサンプルに加え、次のサンプルにも、Python からの他の Microsoft Graph 機能の処理方法が示されています。</span><span class="sxs-lookup"><span data-stu-id="2dc26-142">In addition to the sample covered above, the following samples demonstrate how to work with other features of Microsoft Graph from Python:</span></span>

* [<span data-ttu-id="2dc26-143">Microsoft Graph 用の Python 認証サンプル</span><span class="sxs-lookup"><span data-stu-id="2dc26-143">Python authentication samples for Microsoft Graph</span></span>](https://github.com/microsoftgraph/python-sample-auth)
* [<span data-ttu-id="2dc26-144">Python で改ページされた Microsoft Graph 応答を処理する</span><span class="sxs-lookup"><span data-stu-id="2dc26-144">Working with paginated Microsoft Graph responses in Python</span></span>](https://github.com/microsoftgraph/python-sample-pagination)
* [<span data-ttu-id="2dc26-145">Python で Graph オープン拡張機能を処理する</span><span class="sxs-lookup"><span data-stu-id="2dc26-145">Working with Graph open extensions in Python</span></span>](https://github.com/microsoftgraph/python-sample-open-extensions)

<span data-ttu-id="2dc26-146">表示したい特定のサンプルがある場合、[懸案事項を送信](https://github.com/microsoftgraph/python-sample-auth/issues)してお知らせください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-146">If there's a particular sample you'd like to see, please let us know by [submitting an issue](https://github.com/microsoftgraph/python-sample-auth/issues).</span></span> <span data-ttu-id="2dc26-147">Python で構築する Microsoft Graph シナリオに対するお客様のフィードバックを大いに歓迎いたします。</span><span class="sxs-lookup"><span data-stu-id="2dc26-147">We're very interested in your feedback on any Microsoft Graph scenario you'd like to build in Python!</span></span>

<span data-ttu-id="2dc26-148">Microsoft Graph API は、あらゆる種類の Microsoft データとの対話に使用できる、非常に強力な統合 API です。</span><span class="sxs-lookup"><span data-stu-id="2dc26-148">The Microsoft Graph API is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data. Check out the API reference to explore what else you can accomplish with Microsoft Graph.</span></span> <span data-ttu-id="2dc26-149">[開発者ドキュメント](https://developer.microsoft.com/ja-JP/graph/docs/concepts/overview)または [Graph Explorer](https://developer.microsoft.com/ja-JP/graph/graph-explorer) で、Microsoft Graph によってさらに行える事柄について確認してください。</span><span class="sxs-lookup"><span data-stu-id="2dc26-149">Check out the [developer documentation](https://developer.microsoft.com/ja-JP/graph/docs/concepts/overview) or the [Graph Explorer](https://developer.microsoft.com/ja-JP/graph/graph-explorer) to explore what else you can accomplish with Microsoft Graph.</span></span>
