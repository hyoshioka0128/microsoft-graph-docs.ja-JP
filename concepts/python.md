# <a name="get-started-with-microsoft-graph-in-a-python-app"></a><span data-ttu-id="9f590-101">Python アプリで Microsoft Graph を使ってみる</span><span class="sxs-lookup"><span data-stu-id="9f590-101">Get started with Microsoft Graph in a Python app</span></span> 

<span data-ttu-id="9f590-102">この記事では、Azure AD からアクセス トークンを取得し、Microsoft Graph を呼び出すために必要なタスクについて説明します。</span><span class="sxs-lookup"><span data-stu-id="9f590-102">This article describes the tasks required to get an access token from the v2.0 authentication endpoint and call  Microsoft Graph.</span></span> <span data-ttu-id="9f590-103">ここでは、[Python から Microsoft Graph を介してメールを送信する]((https://github.com/microsoftgraph/python-sample-send-mail))ためのチュートリアルと、Microsoft Graph API を使用するために実装する主要な概念について説明します。</span><span class="sxs-lookup"><span data-stu-id="9f590-103">It walks you through [Sending mail via Microsoft Graph from Python]((https://github.com/microsoftgraph/python-sample-send-mail)) and explains the main concepts that you implement to use the Microsoft Graph API.</span></span> <span data-ttu-id="9f590-104">直接 REST 呼び出しを使用して Microsoft Graph にアクセスする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="9f590-104">The article also describes how to access Microsoft Graph by using REST calls.</span></span>

![[メールの送信] フォーム](https://raw.githubusercontent.com/microsoftgraph/python-sample-send-mail/master/static/images/sendmail.png)

## <a name="choosing-an-authentication-library"></a><span data-ttu-id="9f590-106">認証ライブラリの選択</span><span class="sxs-lookup"><span data-stu-id="9f590-106">Choosing an authentication library</span></span>

<span data-ttu-id="9f590-107">Microsoft Graph を呼び出すには、Microsoft クラウドの ID サービスである Azure Active Directory (Azure AD) から有効なアクセス トークンをアプリが取得し、そのトークンが Microsoft Graph REST API に対する各呼び出しの HTTP ヘッダーに渡される必要があります。</span><span class="sxs-lookup"><span data-stu-id="9f590-107">To make calls to Microsoft Graph, your app must obtain a valid access token from Azure Active Directory (Azure AD), the Microsoft cloud identity service, and the token must be passed in an HTTP header with each call to the Microsoft Graph REST API.</span></span> <span data-ttu-id="9f590-108">Graph での認証方法は OAuth 2.0 と Open ID Connect 標準に基づいているため、アプリケーションで認証を実装するために選択可能な[認証ライブラリ]((https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries))が多数存在します。</span><span class="sxs-lookup"><span data-stu-id="9f590-108">Graph's approach to authentication is based on the OAuth 2.0 and Open ID Connect standards, so there are many [authentication libraries]((https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-libraries)) that you can choose from to implement authentication in your application.</span></span>

<span data-ttu-id="9f590-109">以下に取り上げられているサンプルでは、[Flask-OAuthlib]((https://flask-oauthlib.readthedocs.io/en/latest/)) ライブラリを使用して OAuth 2.0 [認証コードの付与](https://tools.ietf.org/html/rfc6749#section-4.1)ワークフローを実装しています。これは、Python で書かれた Web アプリケーションで推奨されている認証ワークフローです。</span><span class="sxs-lookup"><span data-stu-id="9f590-109">The sample covered below uses the [Flask-OAuthlib]((https://flask-oauthlib.readthedocs.io/en/latest/)) library to implement OAuth 2.0 [Authorization Code Grant](https://tools.ietf.org/html/rfc6749#section-4.1) workflow, which is the recommended auth workflow for web applications written in Python.</span></span> <span data-ttu-id="9f590-110">その他の認証オプションについては、「[Microsoft Graph 用の Python 認証サンプル]((https://github.com/microsoftgraph/python-sample-auth))」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9f590-110">For information about other authentication options, see [Python authentication samples for Microsoft Graph]((https://github.com/microsoftgraph/python-sample-auth)).</span></span>

## <a name="installing-and-running-the-send-mail-sample"></a><span data-ttu-id="9f590-111">メールの送信サンプルのインストールと実行</span><span class="sxs-lookup"><span data-stu-id="9f590-111">Installing and running the send-mail sample</span></span>

<span data-ttu-id="9f590-112">サンプル アプリをインストールして構成するには、「[Python REST サンプルのインストール]((https://github.com/microsoftgraph/python-sample-auth)/blob/master/installation.md)」に記されている説明に従います。</span><span class="sxs-lookup"><span data-stu-id="9f590-112">To install and configure the sample app, follow the instructions in [Installing the Python REST samples]((https://github.com/microsoftgraph/python-sample-auth)/blob/master/installation.md).</span></span> <span data-ttu-id="9f590-113">以下で取り上げられているメールの送信サンプル用に、次のコマンドを使用してリポジトリを複製します。</span><span class="sxs-lookup"><span data-stu-id="9f590-113">For the send-mail sample covered below, use this command to clone the repo:</span></span>

```git clone https://github.com/microsoftgraph/python-sample-send-mail.git```

<span data-ttu-id="9f590-114">[インストール手順]((https://github.com/microsoftgraph/python-sample-auth)/blob/master/installation.md)に記されているように、アプリケーションを登録する際、このサンプルに必要な **User.Read** アクセス許可と **Mail.Send** アクセス許可を必ず含めてください。</span><span class="sxs-lookup"><span data-stu-id="9f590-114">When you register the application as covered in the [installation instructions]((https://github.com/microsoftgraph/python-sample-auth)/blob/master/installation.md), be sure to include the **User.Read** and **Mail.Send** permissions, which are required for this sample.</span></span>

<span data-ttu-id="9f590-115">インストールと構成の完了後、[サンプルの実行]((https://github.com/microsoftgraph/python-sample-send-mail)#running-the-sample)に関する説明に従ってサンプル アプリを実行できます。</span><span class="sxs-lookup"><span data-stu-id="9f590-115">After completing the installation/configuration, you can run the sample app by following the instructions for [running the sample]((https://github.com/microsoftgraph/python-sample-send-mail)#running-the-sample).</span></span>

## <a name="code-walkthrough"></a><span data-ttu-id="9f590-116">コードのチュートリアル</span><span class="sxs-lookup"><span data-stu-id="9f590-116">Code walkthrough</span></span>

<span data-ttu-id="9f590-117">サンプル アプリの[ソース コード]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py)に関する概要を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="9f590-117">The following is an overview of the [source code]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py) for the sample app.</span></span>

<span data-ttu-id="9f590-118">コードの最初の数行は、サンプルで使用される Python のモジュールとパッケージの[インポート]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L4-L32)です。</span><span class="sxs-lookup"><span data-stu-id="9f590-118">The first few lines of code are the [imports]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L4-L32) for the Python modules and packages used in the sample:</span></span>

* <span data-ttu-id="9f590-119">標準ライブラリからの **base64** モジュールは、電子メール添付ファイルのエンコードに使用します。</span><span class="sxs-lookup"><span data-stu-id="9f590-119">The **base64** module from the standard library is used for encoding email attachments.</span></span>
* <span data-ttu-id="9f590-120">**mimetypes** モジュールを使用して添付ファイルの MIME の種類を決定します。</span><span class="sxs-lookup"><span data-stu-id="9f590-120">The **mimetypes** module is used to determine the MIME type for file attachments.</span></span>
* <span data-ttu-id="9f590-121">**os** モジュールは、一般的なファイル システムの機能を提供します。</span><span class="sxs-lookup"><span data-stu-id="9f590-121">The **os** module provides common file system functionality.</span></span>
* <span data-ttu-id="9f590-122">標準ライブラリからの **pprint** モジュールは、Graph が返すエラー メッセージを整形出力するのに使用します。</span><span class="sxs-lookup"><span data-stu-id="9f590-122">The **pprint** module from the standard library is used to pretty-print any error messages returned by Graph.</span></span> <span data-ttu-id="9f590-123">(たとえば、無効な電子メール アドレスに送信する場合。) </span><span class="sxs-lookup"><span data-stu-id="9f590-123">(For example, if you try to send to an invalid email address.)</span></span>
* <span data-ttu-id="9f590-124">標準ライブラリからの **uuid** モジュールは、各 Graph 要求を一意に識別する 36 文字で構成される文字列をランダムに生成するのに使用します。</span><span class="sxs-lookup"><span data-stu-id="9f590-124">The **uuid** module from the standard library is used to generate a random 36-character string to uniquely identify each Graph request.</span></span> <span data-ttu-id="9f590-125">これは、デバッグに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="9f590-125">This can be useful for debugging purposes.</span></span>
* <span data-ttu-id="9f590-126">**flask** パッケージは、サンプル用の Web フレームワークです。</span><span class="sxs-lookup"><span data-stu-id="9f590-126">The **flask** package is the web framework for the sample.</span></span>
* <span data-ttu-id="9f590-127">**flask_oauthlib.client** の **OAuth** クラスは、OAuth 2.0 認証ワークフローを実装する Flask アプリを包含するラッパーです。</span><span class="sxs-lookup"><span data-stu-id="9f590-127">The **OAuth** class of **flask_oauthlib.client** is a wrapper around the Flask app that implements the OAuth 2.0 authentication workflow.</span></span>
* <span data-ttu-id="9f590-128">**config** モジュールには、アプリケーション登録設定 (前述のインストール プロセスで構成した設定など) が含まれます。</span><span class="sxs-lookup"><span data-stu-id="9f590-128">The **config** module contains the application registration settings, as configured in the installation process above.</span></span>

<span data-ttu-id="9f590-129">次に、[Flask アプリを作成]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L15-L17)してから、**MSGRAPH** という名前の [Graph クライアント オブジェクト]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L19-L28)を作成します。</span><span class="sxs-lookup"><span data-stu-id="9f590-129">Next, we [create a Flask app]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L15-L17) and then create the [Graph client object]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L19-L28), named **MSGRAPH**.</span></span>

<span data-ttu-id="9f590-130">これらの初期セットアップ手順によって、認証ワークフローを実装する 3 つの Flask ルート ハンドラー関数 [homepage()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L30-L33)、[login()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L35-L39)、[authorized()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L41-L48) が生成されます。</span><span class="sxs-lookup"><span data-stu-id="9f590-130">After those initial setup steps come three Flask route handler functions that implement the authentication workflow: [homepage()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L30-L33), [login()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L35-L39), and [authorized()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L41-L48).</span></span> <span data-ttu-id="9f590-131">この認証ワークフローの詳細については、Python 認証サンプル リポジトリの「[サンプル アーキテクチャ]((https://github.com/microsoftgraph/python-sample-auth)#sample-architecture)」セクションをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9f590-131">For more information about the authentication workflow, see the [Sample architecture]((https://github.com/microsoftgraph/python-sample-auth)#sample-architecture) section of the Python authentication samples repo.</span></span>

<span data-ttu-id="9f590-132">次のルート ハンドラー [mailform()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L50-L83) は、電子メールの受信者、件名、本文を指定するフォームです。</span><span class="sxs-lookup"><span data-stu-id="9f590-132">The next route handler, [mailform()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L50-L83), is the form where you specify email recipients, subject, and body.</span></span> <span data-ttu-id="9f590-133">なお、この関数にはユーザー プロファイルとプロファイル写真の取得、OneDrive への写真のアップロード、共有リンクの作成など、Graph への最初の呼び出しも含まれます。</span><span class="sxs-lookup"><span data-stu-id="9f590-133">Note that this function also includes our first calls to Graph, including retrieving the user profile and profile photo, uploading the photo to OneDrive, and creating a sharing link.</span></span> <span data-ttu-id="9f590-134">データは [mailform.html テンプレート]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L77-L83)に渡され、そこでメッセージを送信する前に受信者、件名、本文を編集することができます。</span><span class="sxs-lookup"><span data-stu-id="9f590-134">The data is [passed to the mailform.html template]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L77-L83), where the recipient, subject and body can be edited before sending the message.</span></span> 

<span data-ttu-id="9f590-135">次は [send_mail()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L85-L107) 関数です。この関数は、電子メールを送信し、Graph API からの応答を表示します。</span><span class="sxs-lookup"><span data-stu-id="9f590-135">Next is the [send_mail()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L85-L107) function, which sends the email and displays the response from the Graph API.</span></span> <span data-ttu-id="9f590-136">それは sendmail() ヘルパー関数を使用します。この関数には、フォームに入力されたクエリ文字列パラメーターが渡されます。</span><span class="sxs-lookup"><span data-stu-id="9f590-136">It uses a sendmail() helper function, passing to it the query string parameters that were posted from the form:</span></span>

```python
response = sendmail(client=MSGRAPH,
                    subject=flask.request.args['subject'],
                    recipients=flask.request.args['email'].split(';'),
                    body=flask.request.args['body'],
                    attachments=[profile_pic])
```

<span data-ttu-id="9f590-137">[get_token()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L109-L123) 関数が Flask-OAuthlib クライアント インスタンス (```MSGRAPH```) で使用され、Graph に対する呼び出しが行われるたびにアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="9f590-137">The [get_token()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L109-L123) function is used by the Flask-OAuthlib client instance (```MSGRAPH```) to obtain an access token whenever we make calls to Graph.</span></span> <span data-ttu-id="9f590-138">アクセス トークンは **Authorization** という名前の HTTP ヘッダーで渡されますが、コードでこれを処理する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="9f590-138">The access token is passed in an HTTP header named **Authorization**, but you don't need to deal with this in your code.</span></span> <span data-ttu-id="9f590-139">Graph への呼び出しはクライアントの HTTP verb メソッド (get()、post() など) を介して簡単に行えます。クライアント インスタンスは、トークンを取得するための ```get_token()``` の呼び出しを認識します。この関数が、```tokengetter``` で[修飾]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L109-L109)されているためです。</span><span class="sxs-lookup"><span data-stu-id="9f590-139">You can simply make calls to Graph via the client's HTTP verb methods (for example, get() or post()), and the client instance will know to call ```get_token()``` to obtain a token, because the function is [decorated]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L109-L109) with ```tokengetter```.</span></span>

<span data-ttu-id="9f590-140">サンプルの他の部分はヘルパー関数であり、一般的な Graph アクティビティを簡素化するものです。</span><span class="sxs-lookup"><span data-stu-id="9f590-140">The remainder of the sample is helper functions that simplify common Graph activities:</span></span>

* <span data-ttu-id="9f590-141">[request_headers()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L114-L123) は Graph への各呼び出しによって送信される HTTP ヘッダーのディクショナリを返します。</span><span class="sxs-lookup"><span data-stu-id="9f590-141">[request_headers()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L114-L123) returns a dictionary of HTTP headers to be sent with each call to Graph.</span></span>
* <span data-ttu-id="9f590-142">[profile_photo()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L125-L154) はユーザーのプロファイル写真を返し、そのコピーをローカル ファイルに保存します。</span><span class="sxs-lookup"><span data-stu-id="9f590-142">[profile_photo()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L125-L154) returns the user's profile photo and optionally saves a copy to a local file.</span></span>
* <span data-ttu-id="9f590-143">[sendmail()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L156-L202) は ```me/microsoft.graph.sendMail``` エンドポイントを使用してメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="9f590-143">[sendmail()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L156-L202) sends a message using the ```me/microsoft.graph.sendMail``` endpoint.</span></span>
* <span data-ttu-id="9f590-144">[sharing_link()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L204-L221) は OneDrive で指定されたアイテムの共有リンクを作成します。</span><span class="sxs-lookup"><span data-stu-id="9f590-144">[sharing_link()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L204-L221) creates a sharing link for a specified item in OneDrive.</span></span>
* <span data-ttu-id="9f590-145">[upload_file()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L223-L255) は OneDrive にファイルをアップロードします。</span><span class="sxs-lookup"><span data-stu-id="9f590-145">[upload_file()]((https://github.com/microsoftgraph/python-sample-send-mail)/blob/master/sample.py#L223-L255) uploads a file to OneDrive.</span></span>

<span data-ttu-id="9f590-146">これらのヘルパー関数は他のアプリケーションで役立つ場合があります。</span><span class="sxs-lookup"><span data-stu-id="9f590-146">You may find these helper functions useful in other applications.</span></span>

## <a name="other-python-rest-samples"></a><span data-ttu-id="9f590-147">その他の Python REST サンプル</span><span class="sxs-lookup"><span data-stu-id="9f590-147">Other Python REST samples</span></span>

<span data-ttu-id="9f590-148">Microsoft Graph のさまざまな側面の使用方法について、その他の Python サンプルで紹介します。</span><span class="sxs-lookup"><span data-stu-id="9f590-148">Here are some other Python samples that demonstrate how to work with various aspects of Microsoft Graph:</span></span>

* <span data-ttu-id="9f590-149">[Microsoft Graph 用の Python 認証サンプル]((https://github.com/microsoftgraph/python-sample-auth))</span><span class="sxs-lookup"><span data-stu-id="9f590-149">[Python authentication samples for Microsoft Graph]((https://github.com/microsoftgraph/python-sample-auth))</span></span>
* <span data-ttu-id="9f590-150">[Python で改ページされた Microsoft Graph 応答を処理する]((https://github.com/microsoftgraph/python-sample-pagination))</span><span class="sxs-lookup"><span data-stu-id="9f590-150">[Working with paginated Microsoft Graph responses in Python]((https://github.com/microsoftgraph/python-sample-pagination))</span></span>
* <span data-ttu-id="9f590-151">[Python で Graph オープン拡張機能を処理する]((https://github.com/microsoftgraph/python-sample-open-extensions))</span><span class="sxs-lookup"><span data-stu-id="9f590-151">[Working with Graph open extensions in Python]((https://github.com/microsoftgraph/python-sample-open-extensions))</span></span>

<span data-ttu-id="9f590-152">表示したい特定のサンプルがある場合、[懸案事項を送信]((https://github.com/microsoftgraph/python-sample-auth)/issues)してお知らせください。</span><span class="sxs-lookup"><span data-stu-id="9f590-152">If there's a particular sample you'd like to see, please let us know by [submitting an issue]((https://github.com/microsoftgraph/python-sample-auth)/issues).</span></span> <span data-ttu-id="9f590-153">Python で構築する Microsoft Graph シナリオに対するお客様のフィードバックを大いに歓迎いたします。</span><span class="sxs-lookup"><span data-stu-id="9f590-153">We're very interested in your feedback on any Microsoft Graph scenario you'd like to build in Python!</span></span>

<span data-ttu-id="9f590-154">Microsoft Graph API は、あらゆる種類の Microsoft データとの対話に使用できる、非常に強力な統合 API です。</span><span class="sxs-lookup"><span data-stu-id="9f590-154">The Microsoft Graph API is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data. Check out the API reference to explore what else you can accomplish with Microsoft Graph.</span></span> <span data-ttu-id="9f590-155">[開発者ドキュメント]((https://developer.microsoft.com/ja-JP/graph/docs/concepts/overview))または [Graph Explorer]((https://developer.microsoft.com/ja-JP/graph/graph-explorer)) で、Microsoft Graph によってさらに行える事柄について確認してください。</span><span class="sxs-lookup"><span data-stu-id="9f590-155">Check out the [developer documentation]((https://developer.microsoft.com/ja-JP/graph/docs/concepts/overview)) or the [Graph Explorer]((https://developer.microsoft.com/ja-JP/graph/graph-explorer)) to explore what else you can accomplish with Microsoft Graph.</span></span>
