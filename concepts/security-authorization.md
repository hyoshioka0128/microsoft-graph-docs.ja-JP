# <a name="authorization-and-the-security-api-in-microsoft-graph"></a><span data-ttu-id="20b43-101">Microsoft Graph での承認とセキュリティ API</span><span class="sxs-lookup"><span data-stu-id="20b43-101">Authorization and the security API in Microsoft Graph</span></span>

<span data-ttu-id="20b43-102">Microsoft Graph でセキュリティ API からアクセスできるセキュリティ データは機密性が高く、アクセス許可と Azure Active Directory (Azure AD) ロールによって保護されています。</span><span class="sxs-lookup"><span data-stu-id="20b43-102">Security data accessible via the security API in Microsoft Graph is sensitive and is protected by both permissions and Azure Active Directory (Azure AD) roles.</span></span>

<span data-ttu-id="20b43-103">セキュリティ API では 2 種類の承認がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="20b43-103">The security API supports two types of authorization:</span></span>

- <span data-ttu-id="20b43-104">**アプリケーション レベルの承認** - サインインしているユーザーがいません (例: SIEM シナリオ)。</span><span class="sxs-lookup"><span data-stu-id="20b43-104">**Application-level authorization** - There is no signed-in user (for example, a SIEM scenario).</span></span> <span data-ttu-id="20b43-105">アプリケーションに付与されたアクセス許可によって、承認が決定します。</span><span class="sxs-lookup"><span data-stu-id="20b43-105">The permissions granted to the application determine authorization.</span></span> 
    ><span data-ttu-id="20b43-106">**注:** このオプションは、アプリケーションがロール ベースのアクセス制御 (RBAC) を管理しているケースにも対応します。</span><span class="sxs-lookup"><span data-stu-id="20b43-106">**Note:** This option can also support cases where Role-Based Access Control (RBAC) is managed by the application.</span></span>
- <span data-ttu-id="20b43-107">**ユーザーにより委任された承認** - Azure AD テナントのメンバーであるユーザーがサインインしています。</span><span class="sxs-lookup"><span data-stu-id="20b43-107">**User delegated authorization** - A user who is a member of the Azure AD tenant is signed in.</span></span> <span data-ttu-id="20b43-108">アプリケーションに必要なアクセス許可が付与されており、ユーザーが Azure AD 制限付き管理者ロール ([セキュリティ閲覧者] または [セキュリティ管理者]) のメンバーである必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-108">The user must be a member of an Azure AD Limited Admin role - either Security Reader or Securty Administrator - in addition to the application having been granted the required permissions.</span></span>

<span data-ttu-id="20b43-109">Graph エクスプローラーからセキュリティ API を呼び出す場合:</span><span class="sxs-lookup"><span data-stu-id="20b43-109">If you're calling the security API from Graph Explorer:</span></span>

- <span data-ttu-id="20b43-110">Azure AD テナント管理者は、要求されたアクセス許可を Graph エクスプローラー アプリケーションに付与することに明示的に同意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-110">The Azure AD tenant admin must explicitly grant consent for the requested permissions to the Graph Explorer application.</span></span>
- <span data-ttu-id="20b43-111">ユーザーは、Azure AD の [セキュリティ閲覧者] 制限付き管理者ロールのメンバーである必要があります ([セキュリティ閲覧者] または [セキュリティ管理者] のいずれか)。</span><span class="sxs-lookup"><span data-stu-id="20b43-111">The user must be a member of the Security Reader Limited Admin role in Azure AD (either Security Reader or Security Administrator).</span></span>

><span data-ttu-id="20b43-112">**注**: Graph エクスプローラーでは、アプリケーション レベルの承認がサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="20b43-112">**Note**: Graph Explorer does not support application-level authorization.</span></span>

<span data-ttu-id="20b43-113">カスタム アプリケーションまたは独自のアプリケーションからセキュリティ API を呼び出す場合:</span><span class="sxs-lookup"><span data-stu-id="20b43-113">If you're calling the security API from a custom or your own application:</span></span>

- <span data-ttu-id="20b43-114">Azure AD テナント管理者は、アプリケーションに対して明示的に承認を与える必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-114">The Azure AD tenant admin must explicitly grant consent to your application.</span></span> <span data-ttu-id="20b43-115">これは、アプリケーション レベルの承認と、ユーザーにより委任された承認の両方に必要です。</span><span class="sxs-lookup"><span data-stu-id="20b43-115">This is required both for application-level authorization and user delegated authorization.</span></span>
- <span data-ttu-id="20b43-116">ユーザーにより委任された承認を使用する場合、ユーザーは、Azure AD の [セキュリティ閲覧者] または [セキュリティ管理者] 制限付き管理者ロールのメンバーである必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-116">If you're using user delegated authorization, the user must be a member of the Security Reader or Security Administrator Limited Admin role in Azure AD.</span></span>

## <a name="manage-authorization-in-security-api-client-applications"></a><span data-ttu-id="20b43-117">セキュリティ API クライアント アプリケーションで承認を管理する</span><span class="sxs-lookup"><span data-stu-id="20b43-117">Manage authorization in security API client applications</span></span>

<span data-ttu-id="20b43-118">Microsoft Graph でセキュリティ API から提供されるセキュリティ データは機密性が高く、適切な認証および承認メカニズムを使用して保護する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-118">Security data provided via the security API in Microsoft Graph is sensitive and must be protected by appropriate authentication and authorization mechanisms.</span></span> <span data-ttu-id="20b43-119">次の表に、セキュリティ API にアクセスできるクライアント アプリケーションを登録および作成する手順を示します。</span><span class="sxs-lookup"><span data-stu-id="20b43-119">The following table lists the steps to register and create a client application that can access the security API.</span></span>

| <span data-ttu-id="20b43-120">**対象者**</span><span class="sxs-lookup"><span data-stu-id="20b43-120">**Who**</span></span> | <span data-ttu-id="20b43-121">**操作**</span><span class="sxs-lookup"><span data-stu-id="20b43-121">**Action**</span></span> |
|:---------------------|:------------------|
|<span data-ttu-id="20b43-122">アプリケーション開発者または所有者</span><span class="sxs-lookup"><span data-stu-id="20b43-122">Application developer or owner</span></span>|<span data-ttu-id="20b43-123">アプリケーションをエンタープライズ アプリケーションとして登録します。</span><span class="sxs-lookup"><span data-stu-id="20b43-123">Register the application as an enterprise application.</span></span>|
|<span data-ttu-id="20b43-124">テナント管理者</span><span class="sxs-lookup"><span data-stu-id="20b43-124">Tenant admin</span></span>|<span data-ttu-id="20b43-125">アプリケーションにアクセス許可を付与します。</span><span class="sxs-lookup"><span data-stu-id="20b43-125">Grant permissions to your application.</span></span>|
|<span data-ttu-id="20b43-126">テナント管理者</span><span class="sxs-lookup"><span data-stu-id="20b43-126">Tenant admin</span></span>|<span data-ttu-id="20b43-127">ユーザーにロールを割り当てます。</span><span class="sxs-lookup"><span data-stu-id="20b43-127">Assign roles to users.</span></span>|
|<span data-ttu-id="20b43-128">アプリケーション開発者</span><span class="sxs-lookup"><span data-stu-id="20b43-128">Application developer</span></span>|<span data-ttu-id="20b43-129">ユーザーとしてサインインし、アプリケーションを使用してセキュリティ API にアクセスします。</span><span class="sxs-lookup"><span data-stu-id="20b43-129">Sign in as the user and use the application to access the security API.</span></span>|

<span data-ttu-id="20b43-130">アプリケーションの登録では、アプリケーションの実行に必要なアクセス許可だけが定義されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-130">Application registration only defines which permissions the application needs in order to run.</span></span> <span data-ttu-id="20b43-131">これらのアクセス許可はアプリケーションに付与されません。</span><span class="sxs-lookup"><span data-stu-id="20b43-131">It does NOT grant these permissions to the application.</span></span>

<span data-ttu-id="20b43-132">Azure AD テナント管理者は、アプリケーションにアクセス許可を明示的に付与する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-132">The Azure AD tenant administrator MUST explicitly grant the permissions to the application.</span></span> <span data-ttu-id="20b43-133">これはテナントごとに実行し、またアプリケーション登録ポータルでアプリケーションのアクセス許可が変更される*たびに実行する*必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-133">This must be done per tenant and must be *performed every time* the application permissions are changed in the application registration portal.</span></span>

<span data-ttu-id="20b43-134">たとえば、2 つの Azure AD テナント (**T1** および **T2**) と 2 つのアクセス許可 (**P1** および **P2**) があるとします。</span><span class="sxs-lookup"><span data-stu-id="20b43-134">For example, assume that you have an application, two Azure AD tenants, **T1** and **T2**, and two permissions, **P1** and **P2**.</span></span> <span data-ttu-id="20b43-135">承認プロセスを以下に示します。</span><span class="sxs-lookup"><span data-stu-id="20b43-135">The following is the basic authorization flow.</span></span>

- <span data-ttu-id="20b43-136">アプリケーションがアクセス許可 **P1** を必要とすることが登録されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-136">The application registers to require permission **P1**.</span></span>
- <span data-ttu-id="20b43-137">テナント **T1** のユーザーがこのアプリケーションの Azure AD トークンを取得すると、このトークンにはアクセス許可が含まれていません。</span><span class="sxs-lookup"><span data-stu-id="20b43-137">When users in tenant **T1** get an Azure AD token for this application, the token does not contain any permissions.</span></span>
- <span data-ttu-id="20b43-138">テナント **T1** の Azure AD 管理者が、アプリケーションにアクセス許可を明示的に付与します。</span><span class="sxs-lookup"><span data-stu-id="20b43-138">The Azure AD admin of tenant **T1** explicitly grants permissions to the application.</span></span> <span data-ttu-id="20b43-139">テナント **T1** のユーザーがこのアプリケーションの Azure AD トークンを取得すると、このトークンにはアクセス許可 **P1** が含まれています。</span><span class="sxs-lookup"><span data-stu-id="20b43-139">When users in tenant **T1** get an Azure AD token for the application, it will contain permission **P1**.</span></span>
- <span data-ttu-id="20b43-140">テナント **T2** のユーザーがアプリケーションの Azure AD トークンを取得すると、このトークンにはアクセス許可が含まれていません。これは、テナント **T2** の管理者がアプリケーションにアクセス許可をまだ付与していないためです。</span><span class="sxs-lookup"><span data-stu-id="20b43-140">When users in tenant **T2** get an Azure AD token for the application, the token does not contain any permissions - because the admin of tenant **T2** did not yet grant permissions to the application.</span></span> <span data-ttu-id="20b43-141">アクセス許可は*テナントごと*および*アプリケーションごと*に付与する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-141">Permission must be granted *per tenant* and *per application*.</span></span>
- <span data-ttu-id="20b43-142">アプリケーションの登録が変更され、アクセス許可 **P1** と **P2** が必要になりました。</span><span class="sxs-lookup"><span data-stu-id="20b43-142">The application has its registration changed to now require permissions **P1** and **P2**.</span></span>
- <span data-ttu-id="20b43-143">テナント **T1** のユーザーがこのアプリケーションの Azure AD トークンを取得すると、このトークンにはアクセス許可 **P1** だけが含まれています。</span><span class="sxs-lookup"><span data-stu-id="20b43-143">When users in tenant **T1** get an Azure AD token for the application, it only contains permission **P1**.</span></span> <span data-ttu-id="20b43-144">アプリケーションに付与されたアクセス許可は、付与された内容のスナップショットとして記録されます。アプリケーションの登録 (アクセス許可) を変更しても、アクセス許可は*自動的には変更されません*。</span><span class="sxs-lookup"><span data-stu-id="20b43-144">Permissions granted to an application are recorded as snapshots of what was granted - they *do not change automatically* after the application registration (permission) changes.</span></span>
- <span data-ttu-id="20b43-145">テナント **T2** の管理者がアクセス許可 **P1** と **P2** をアプリケーションに付与します。</span><span class="sxs-lookup"><span data-stu-id="20b43-145">The admin of tenant **T2** grants permissions **P1** and **P2** to the application.</span></span> <span data-ttu-id="20b43-146">次にテナント **T2** のユーザーがこのアプリケーションの Azure AD トークンを取得すると、このトークンにはアクセス許可 **P1** と **P2** が含まれています。</span><span class="sxs-lookup"><span data-stu-id="20b43-146">Now, when users in tenant **T2** get an Azure AD token for the application, the token will contain permissions **P1** and **P2**.</span></span>

><span data-ttu-id="20b43-147">**注**: テナント **T1** のアプリケーションとテナント **T2** のアプリケーションの Azure AD トークンに含まれているアクセス許可はそれぞれ異なります。これは、それぞれのテナント管理者がアプリケーションに対して異なるアクセス許可を付与しているためです。</span><span class="sxs-lookup"><span data-stu-id="20b43-147">**Note**: The Azure AD tokens for the application in tenant **T1** and the application in tenant **T2** contain different permissions, because each tenant admin has granted different permissions to the application.</span></span>

- <span data-ttu-id="20b43-148">アプリケーションをテナント **T1** で再び実行できるようにするには、テナント **T1** の管理者が、アクセス許可 **P1** と **P2** をアプリケーションに明示的に付与する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-148">To make the application work again in tenant **T1**, the admin of tenant **T1** must explicitly grant permissions **P1** and **P2** to the application.</span></span>

## <a name="register-an-application-in-the-azure-ad-v20-endpoint"></a><span data-ttu-id="20b43-149">Azure AD v2.0 エンドポイントでアプリケーションを登録する</span><span class="sxs-lookup"><span data-stu-id="20b43-149">Register an application in the Azure AD v2.0 endpoint</span></span>

<span data-ttu-id="20b43-150">Azure AD v2.0 エンドポイントでアプリケーションを登録するには、次の情報が必要です。</span><span class="sxs-lookup"><span data-stu-id="20b43-150">To register an application to the Azure AD v2.0 endpoint, you'll need:</span></span>

- <span data-ttu-id="20b43-151">**アプリケーション名** - アプリケーション名として使用される文字列。</span><span class="sxs-lookup"><span data-stu-id="20b43-151">**Application name** - A string used for the application name.</span></span>
- <span data-ttu-id="20b43-152">**リダイレクト URL** - Azure AD からの承認応答の送信先 URL。</span><span class="sxs-lookup"><span data-stu-id="20b43-152">**Redirect URL** - The URL where the authentication response from Azure AD is sent.</span></span> <span data-ttu-id="20b43-153">最初に、テスト クライアント Web アプリケーション ホーム ページを使用できます。</span><span class="sxs-lookup"><span data-stu-id="20b43-153">To start, you can use the test client web app homepage.</span></span>
- <span data-ttu-id="20b43-154">**必要なアクセス許可** - アプリケーションが Microsoft Graph を呼び出すことができるようにするために必要なアクセス許可。</span><span class="sxs-lookup"><span data-stu-id="20b43-154">**Required Permissions** - The permissions that your application requires to be able to call Microsoft Graph.</span></span>

<span data-ttu-id="20b43-155">アプリケーションを登録するには、次の操作を行います。</span><span class="sxs-lookup"><span data-stu-id="20b43-155">To register your application:</span></span>

1. <span data-ttu-id="20b43-156">https://apps.dev.microsoft.com/ に移動し、サインインします。</span><span class="sxs-lookup"><span data-stu-id="20b43-156">Go to the https://apps.dev.microsoft.com/ and sign in.</span></span>
    ><span data-ttu-id="20b43-157">**注**: テナント管理者である必要はありません。**[マイ アプリケーション]** リストにリダイレクトされます。</span><span class="sxs-lookup"><span data-stu-id="20b43-157">**Note**: You don't have to be a tenant admin. You will be redirected to the **My applications** list.</span></span>
2. <span data-ttu-id="20b43-158">新しいアプリケーションを作成するため、**[アプリの追加]** を選択し、**[アプリケーション名]** にアプリケーションを入力します、</span><span class="sxs-lookup"><span data-stu-id="20b43-158">Choose **Add an app**, and enter an **Application Name** to create a new application.</span></span>
3. <span data-ttu-id="20b43-159">新しいアプリケーションの登録ページで **[プラットフォームの追加]** > **[Web]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-159">On the registration page for the new application, choose **Add Platform** > **Web**.</span></span> <span data-ttu-id="20b43-160">**[リダイレクト URL]** フィールドにリダイレクト URL を入力します。</span><span class="sxs-lookup"><span data-stu-id="20b43-160">In the **Redirect URL** field, enter the redirect URL.</span></span>
4. <span data-ttu-id="20b43-161">**[Microsoft Graph のアクセス許可]** セクションの **[委任されたアクセス許可]** で、**[追加]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-161">In the **Microsoft Graph Permissions** section, under **Delegated Permissions**, choose **Add**.</span></span> <span data-ttu-id="20b43-162">ダイアログ ボックスで、必要なアクセス許可を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-162">In the dialog box, choose the required permissions.</span></span> <span data-ttu-id="20b43-163">アクセス許可のリストについては、「[セキュリティのアクセス許可](../concepts/permissions_reference.md#security-permissions)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-163">For a list of permissions, see [Security permissions](../concepts/permissions_reference.md#security-permissions).</span></span>

    ><span data-ttu-id="20b43-164">セキュリティ API では、GET クエリに SecurityEvents.Read.All スコープ、PATCH/POST クエリに SecurityEvents.ReadWrite.All スコープが必要です。</span><span class="sxs-lookup"><span data-stu-id="20b43-164">The security API requires the SecurityEvents.Read.All scope for GET queries, and the SecurityEvents.ReadWrite.All scope for PATCH/POST queries.</span></span>

5. <span data-ttu-id="20b43-165">**[保存]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-165">Choose **Save**.</span></span>

<span data-ttu-id="20b43-166">以下の情報を保存します。</span><span class="sxs-lookup"><span data-stu-id="20b43-166">Returns the following information:</span></span>

- <span data-ttu-id="20b43-167">アプリケーション ID</span><span class="sxs-lookup"><span data-stu-id="20b43-167">Application ID</span></span>
- <span data-ttu-id="20b43-168">リダイレクト URL</span><span class="sxs-lookup"><span data-stu-id="20b43-168">Redirect URL</span></span>
- <span data-ttu-id="20b43-169">必要なアクセス許可のリスト</span><span class="sxs-lookup"><span data-stu-id="20b43-169">List of required permissions</span></span>

<span data-ttu-id="20b43-170">詳細については、「[アプリを Azure AD v2.0 エンドポイントに登録する](../concepts/auth_register_app_v2.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-170">For more information about supported app types with the Azure AD v2.0 endpoint, see [Types of apps](../concepts/auth_register_app_v2.md).</span></span>

## <a name="grant-permissions-to-an-application"></a><span data-ttu-id="20b43-171">アプリケーションにアクセス許可を付与する</span><span class="sxs-lookup"><span data-stu-id="20b43-171">Grant permissions to your application.</span></span>

<span data-ttu-id="20b43-172">アプリケーションの登録では、アプリケーションに必要なアクセス許可が定義されますが、アプリケーションにこれらのアクセス許可は付与されません。</span><span class="sxs-lookup"><span data-stu-id="20b43-172">Application registration only defines which permission the application requires - it does not grant these permissions to the application.</span></span> <span data-ttu-id="20b43-173">Azure AD テナント管理者は、管理者の同意エンドポイントを呼び出して、これらのアクセス許可を明示的に付与する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-173">An Azure AD tenant administrator must explicitly grant these permissions by making a call to the admin consent endpoint.</span></span> <span data-ttu-id="20b43-174">詳細については、「[管理者の同意エンドポイントを使用する](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-scopes#using-the-admin-consent-endpoint)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-174">For details, see [Using the admin consent endpoint](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-scopes#using-the-admin-consent-endpoint).</span></span>

<span data-ttu-id="20b43-175">アプリケーションにアクセス許可を付与するには、以下の情報が必要です。</span><span class="sxs-lookup"><span data-stu-id="20b43-175">To grant permissions to an application, you'll need:</span></span>

- <span data-ttu-id="20b43-176">**アプリケーション ID** - アプリケーション登録ポータルのアプリケーション ID。</span><span class="sxs-lookup"><span data-stu-id="20b43-176">**Application ID** - The application ID from application registration portal.</span></span>
- <span data-ttu-id="20b43-177">**リダイレクト URL** - アプリケーション登録ポータルで認証応答のために設定した文字列。</span><span class="sxs-lookup"><span data-stu-id="20b43-177">**Redirect URL** - The string you set in the application registration portal for authentication response.</span></span>

<span data-ttu-id="20b43-178">アクセス許可を付与するには、次の操作を行います。</span><span class="sxs-lookup"><span data-stu-id="20b43-178">To grant the permissions:</span></span>

- <span data-ttu-id="20b43-179">テキスト エディターで、以下の URL 文字列を作成します。</span><span class="sxs-lookup"><span data-stu-id="20b43-179">In a text editor, create following URL string:</span></span>

    `https://login.microsoftonline.com/common/adminconsent?client_id=<Application Id>&state=12345&redirect_uri=<Redirect URL>`

- <span data-ttu-id="20b43-180">Web ブラウザーでこの URL に移動し、テナント管理者としてサインインします。</span><span class="sxs-lookup"><span data-stu-id="20b43-180">In a web browser, go to this URL, and sign in as a tenant administrator.</span></span> <span data-ttu-id="20b43-181">ダイアログ ボックスに、アプリケーション登録ポータルで指定した、アプリケーションに必要なアクセス許可のリストが表示されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-181">The dialog box shows the list of permission the application requires, as specified in the application registration portal.</span></span> <span data-ttu-id="20b43-182">**[OK]** を選択し、アプリケーションにこれらのアクセス許可を付与します。</span><span class="sxs-lookup"><span data-stu-id="20b43-182">Choose **OK** to grant the application these permissions.</span></span>

> <span data-ttu-id="20b43-183">**注:** この手順では、アクセス許可がユーザーではなくアプリケーションに付与されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-183">**Note:** This step grants permissions to the application - not to users.</span></span> <span data-ttu-id="20b43-184">つまり、このアプリケーションを使用する Azure AD テナントに属するすべてのユーザー (管理者以外のユーザーを含む) に、これらのアクセス許可が付与されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-184">This means that all users belonging to the Azure AD tenant that use this application will be granted these permissions - even non-admin users.</span></span>

## <a name="assign-azure-ad-roles-to-users"></a><span data-ttu-id="20b43-185">Azure AD のロールをユーザーに割り当てる</span><span class="sxs-lookup"><span data-stu-id="20b43-185">Assign Azure AD roles to users</span></span>

<span data-ttu-id="20b43-186">アプリケーションにアクセス許可が付与されると、そのアプリケーションにアクセスできるすべてのユーザー (Azure AD テナントのメンバー) に、付与されたアクセス許可が与えられます。</span><span class="sxs-lookup"><span data-stu-id="20b43-186">After an application is granted permissions, everyone with access to the application (that is, members of the Azure AD tenant) will receive the granted permissions.</span></span> <span data-ttu-id="20b43-187">機密性の高いセキュリティ データの保護を強化するため、セキュリティ API では、ユーザーに Azure AD の **[セキュリティ閲覧者]** ロールが割り当てられている必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-187">To further protect sensitive security data, the security API also requires users to be assigned the Azure AD **Security Reader** role.</span></span> <span data-ttu-id="20b43-188">詳細については、「[Azure Active Directory での管理者ロールの割り当て](https://docs.microsoft.com/ja-JP/azure/active-directory/active-directory-assign-admin-roles-azure-portal)」と「[Azure Active Directory でユーザーを管理者ロールに割り当てる](https://docs.microsoft.com/ja-JP/azure/active-directory/active-directory-users-assign-role-azure-portal)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-188">For details, see [Assigning administrator roles](https://docs.microsoft.com/ja-JP/azure/active-directory/active-directory-assign-admin-roles-azure-portal) and [Assign a user to adminstrator roles](https://docs.microsoft.com/ja-JP/azure/active-directory/active-directory-users-assign-role-azure-portal).</span></span>

><span data-ttu-id="20b43-189">**注:** この手順を実行するには、テナント管理者でなければなりません。</span><span class="sxs-lookup"><span data-stu-id="20b43-189">**Note:** You must be a tenant admin to perform this step.</span></span>

<span data-ttu-id="20b43-190">ユーザーにロールを割り当てるには、次の操作を行います。</span><span class="sxs-lookup"><span data-stu-id="20b43-190">To assign roles to users:</span></span>

- <span data-ttu-id="20b43-191">[Azure Portal](https://portal.azure.com) (http://portal.azure.com) にサインインします。</span><span class="sxs-lookup"><span data-stu-id="20b43-191">Sign in to the [azure portal](https://portal.azure.com) (http://portal.azure.com).</span></span>
- <span data-ttu-id="20b43-192">メニューで **[Azure Active Directory]** > **[ユーザー]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-192">In the menu, select **Azure Active Directory** > **Users**.</span></span>
- <span data-ttu-id="20b43-193">ユーザーの名前を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-193">Returns the user name of the user.</span></span>
- <span data-ttu-id="20b43-194">**[管理]** > **[ディレクトリ ロール]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-194">Select **Manage** > **Directory role**.</span></span>
- <span data-ttu-id="20b43-195">**[制限付き管理者]** を選択し、**[セキュリティ閲覧者]** チェック ボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="20b43-195">Select **Limited administrator**, and choose the **Security reader** check box.</span></span>
- <span data-ttu-id="20b43-196">**[保存]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="20b43-196">Choose **Save**.</span></span>

## <a name="create-an-authentication-code"></a><span data-ttu-id="20b43-197">認証コードを作成する</span><span class="sxs-lookup"><span data-stu-id="20b43-197">Obtaining an authentication code</span></span>

<span data-ttu-id="20b43-198">認証コードを作成するには、以下の情報が必要です。</span><span class="sxs-lookup"><span data-stu-id="20b43-198">To create an authentication code, you'll need:</span></span>

- <span data-ttu-id="20b43-199">**アプリケーション ID** - アプリケーション登録ポータルのアプリケーション ID。</span><span class="sxs-lookup"><span data-stu-id="20b43-199">**Application ID** - The application ID from application registration portal.</span></span>
- <span data-ttu-id="20b43-200">**リダイレクト URL** - Azure AD からの承認応答の送信先 URL。</span><span class="sxs-lookup"><span data-stu-id="20b43-200">**Redirect URL** - The URL where the authentication response from Azure AD is sent.</span></span> <span data-ttu-id="20b43-201">最初に、http://localhost またはテスト クライアント Web アプリケーション ホーム ページを使用できます。</span><span class="sxs-lookup"><span data-stu-id="20b43-201">To start, you can use http://localhost or the test client web app homepage.</span></span>
- <span data-ttu-id="20b43-202">**アプリケーション キー** (オプション) - アプリケーションのキー。</span><span class="sxs-lookup"><span data-stu-id="20b43-202">**Application Key** (optional) - The key of the application.</span></span> <span data-ttu-id="20b43-203">これは、アプリケーション専用認証コードを使用するアプリケーションを開発する場合に適用されます (つまりユーザーにより委任される認証はサポートされません)。</span><span class="sxs-lookup"><span data-stu-id="20b43-203">This applies when you're developing an application that will use application-only authentication code (that is, will not support user delegated authentication).</span></span>

<span data-ttu-id="20b43-204">次の表に、認証コードの作成に使用できるリソースを示します。</span><span class="sxs-lookup"><span data-stu-id="20b43-204">The following table lists resources that you can use to create an authentication code.</span></span>

|<span data-ttu-id="20b43-205">**アプリケーションの種類**</span><span class="sxs-lookup"><span data-stu-id="20b43-205">**Type of application**</span></span>|<span data-ttu-id="20b43-206">**認証ライブラリ**</span><span class="sxs-lookup"><span data-stu-id="20b43-206">**Authentication library**</span></span>|
|------------------------|----------------------------|
|[<span data-ttu-id="20b43-207">デスクトップ アプリケーション - iOS</span><span class="sxs-lookup"><span data-stu-id="20b43-207">Desktop apps - iOS</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/guidedsetups/active-directory-ios)|[<span data-ttu-id="20b43-208">MSAL.framework: iOS 用 Microsoft Authentication Library プレビュー</span><span class="sxs-lookup"><span data-stu-id="20b43-208">MSAL.framework: Microsoft Authentication Library Preview for iOS</span></span>](https://github.com/AzureAD/microsoft-authentication-library-for-objc)|
|[<span data-ttu-id="20b43-209">デスクトップ アプリケーション - Android</span><span class="sxs-lookup"><span data-stu-id="20b43-209">Desktop apps - Android</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/guidedsetups/active-directory-android)|[<span data-ttu-id="20b43-210">Microsoft Authentication Library (MSAL)</span><span class="sxs-lookup"><span data-stu-id="20b43-210">Microsoft Authentication Library (MSAL) for .NET</span></span>](http://javadoc.io/doc/com.microsoft.identity.client/msal)|
|[<span data-ttu-id="20b43-211">デスクトップ アプリケーション - .Net</span><span class="sxs-lookup"><span data-stu-id="20b43-211">Desktop apps - .Net</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/guidedsetups/active-directory-windesktop)|[<span data-ttu-id="20b43-212">Microsoft Authentication Library (MSAL)</span><span class="sxs-lookup"><span data-stu-id="20b43-212">Microsoft Authentication Library (MSAL) for .NET</span></span>](https://www.nuget.org/packages/Microsoft.Identity.Client)|
|[<span data-ttu-id="20b43-213">Web アプリケーション - JavaScript SPA</span><span class="sxs-lookup"><span data-stu-id="20b43-213">Web apps - JavaScript SPA</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/guidedsetups/active-directory-javascriptspa)|[<span data-ttu-id="20b43-214">JavaScript 用 Microsoft Authentication Library プレビュー</span><span class="sxs-lookup"><span data-stu-id="20b43-214">Microsoft Authentication Library for JavaScript</span></span>](https://github.com/AzureAD/microsoft-authentication-library-for-js)|
|[<span data-ttu-id="20b43-215">Web アプリケーション - .NET Web Server</span><span class="sxs-lookup"><span data-stu-id="20b43-215">Web apps - .NET Web Server</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/guidedsetups/active-directory-aspnetwebapp)|<span data-ttu-id="20b43-216">OpenIdConnection、Cookies、SystemWeb</span><span class="sxs-lookup"><span data-stu-id="20b43-216">OpenIdConnection, Cookies, SystemWeb</span></span>|
|[<span data-ttu-id="20b43-217">Web アプリケーション - NodeJS Web アプリケーション</span><span class="sxs-lookup"><span data-stu-id="20b43-217">Web apps - NodeJS Web App</span></span>](https://docs.microsoft.com/ja-JP/azure/active-directory/develop/active-directory-v2-devquickstarts-node-web)||

<span data-ttu-id="20b43-218">既存のライブラリを使用しないアプリケーションの場合は、「[ユーザーの代わりにアクセスを取得](../concepts/auth_v2_user.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-218">For applications that don't use any of the existing libraries, see [Get access on behalf of a user](../concepts/auth_v2_user.md).</span></span>

1. <span data-ttu-id="20b43-219">Azure AD からコードを取得します。</span><span class="sxs-lookup"><span data-stu-id="20b43-219">Get a code from Azure AD.</span></span> <span data-ttu-id="20b43-220">呼び出すクエリには、アプリケーション ID、リダイレクト URI、および**必要なアクセス許可**のパラメーターが指定されています。</span><span class="sxs-lookup"><span data-stu-id="20b43-220">The query to call contains parameter for Application ID, Redirect URl, and **required permissions**.</span></span>
2. <span data-ttu-id="20b43-221">コードを使用してアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="20b43-221">Use the context token to get an access token</span></span>

<span data-ttu-id="20b43-222">OpenId Connect ライブラリを使用する場合は、「[Azure AD および OpenID Connect を使用して認証する](https://docs.microsoft.com/ja-JP/azure/architecture/multitenant-identity/authenticate)」を参照し、`app.UseOpenIdConnectAuthentication()` を呼び出してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-222">If you use OpenId Connect library, see [Authenticate using Azure AD and OpenID Connect](https://docs.microsoft.com/ja-JP/azure/architecture/multitenant-identity/authenticate) and call `app.UseOpenIdConnectAuthentication()`.</span></span>

><span data-ttu-id="20b43-223">**注:** ユーザーにより委任された認証トークンを要求する場合、ライブラリのパラメーターは **Requested Scopes** です。</span><span class="sxs-lookup"><span data-stu-id="20b43-223">**Note:** If you're requesting user delegated authentication tokens, the parameter for the library is **Requested Scopes**.</span></span> <span data-ttu-id="20b43-224">このパラメーターには、登録アプリケーションに必要なスコープではなく、User.Read を使用してください。</span><span class="sxs-lookup"><span data-stu-id="20b43-224">Use User.Read for this parameter instead of what the registered application requires.</span></span> <span data-ttu-id="20b43-225">**Requested Scopes** パラメーターは、返される認証トークンに含まれるアクセス許可には影響しません。</span><span class="sxs-lookup"><span data-stu-id="20b43-225">The **Requested Scopes** parameter does NOT affect the permissions contained in the returned authentication tokens.</span></span> <span data-ttu-id="20b43-226">これらのアクセス許可は、テナント管理者がアプリケーションに付与したアクセス許可によって決定します。</span><span class="sxs-lookup"><span data-stu-id="20b43-226">These are determined by the permissions that the tenant admin granted the application.</span></span>

<span data-ttu-id="20b43-227">たとえば .NET MSAL ライブラリを使用している場合には、次のように呼び出します。</span><span class="sxs-lookup"><span data-stu-id="20b43-227">For example, if you're using the .NET MSAL library, call the following:</span></span>

`var accessToken = (await client.AcquireTokenAsync(scopes)).AccessToken;`

><span data-ttu-id="20b43-228">**注:** この例では、最小限の特権を持つアクセス許可 (User.Read など) を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="20b43-228">**Note:** This example should use the least privileged permission, such as User.Read.</span></span> <span data-ttu-id="20b43-229">ただし、返されるアクセス トークンには、テナント管理者が現在のユーザー テナントに付与したアクセス許可 (User.Read.All、User.ReadWrite.All など) が含まれることがあります。</span><span class="sxs-lookup"><span data-stu-id="20b43-229">However, the returned access token can contain permissions that were granted by the tenant admin for the current user tenant, such as User.Read.All or User.ReadWrite.All.</span></span>

<span data-ttu-id="20b43-230">Azure AD により、認証情報とアプリケーションに必要なアクセス許可が含まれているトークン (文字列) が返されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-230">A token (string) is returned by Azure AD that contains your authentication information and the permissions required by the application.</span></span> <span data-ttu-id="20b43-231">以下の例に示すように、このトークンをベアラー トークンとして HTTP ヘッダーに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="20b43-231">Assign this token to the HTTP header as a bearer token, as shown in the following example.</span></span>

`request.Headers.Authorization = new AuthenticationHeaderValue("bearer", accessToken);`

<span data-ttu-id="20b43-232">Microsoft Graph により、このトークンに含まれている情報が検証され、アクセスが付与または拒否されます。</span><span class="sxs-lookup"><span data-stu-id="20b43-232">Microsoft Graph will validate the information contained in this token and grant, or reject, access.</span></span>

<span data-ttu-id="20b43-233">返されるトークンに含まれている要求を確認するには、NuGet library System.IdentityModel.Tokens.Jwt を使用します。</span><span class="sxs-lookup"><span data-stu-id="20b43-233">To view claims contained in the returned token, use NuGet library System.IdentityModel.Tokens.Jwt.</span></span>

`JwtSecurityTokenHandler tokenHandler = new JwtSecurityTokenHandler();`</br>
`var securityToken = tokenHandler.ReadToken(accessToken) as JwtSecurityToken;`

<span data-ttu-id="20b43-234">Microsoft Graph からの応答には、client-request-id というヘッダーが含まれています。これは GUID です。</span><span class="sxs-lookup"><span data-stu-id="20b43-234">The response from Microsoft Graph contains a header called client-request-id, which is a GUID.</span></span> <span data-ttu-id="20b43-235">アクセスが拒否される場合は、[Microsoft 技術コミュニティ](https://techcommunity.microsoft.com/t5/Microsoft-Graph-Security-API/ct-p/SecurityGraphAPI)でサポートを要請する際にこの GUID を指定してください。これにより、この認証エラーの原因の調査を支援できます。</span><span class="sxs-lookup"><span data-stu-id="20b43-235">If access is denied, please specify this GUID when seeking support at [Microsoft Tech Community](https://techcommunity.microsoft.com/t5/Microsoft-Graph-Security-API/ct-p/SecurityGraphAPI), so we can help investigate the cause of this authentication failure.</span></span>
